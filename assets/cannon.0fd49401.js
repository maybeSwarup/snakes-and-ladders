function xe(ge){throw new Error('Could not dynamically require "'+ge+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var Be={exports:{}};(function(ge,Ee){(function(v){ge.exports=v()})(function(){return function v(I,ht,p){function e(l,o){if(!ht[l]){if(!I[l]){var t=typeof xe=="function"&&xe;if(!o&&t)return t(l,!0);if(n)return n(l,!0);throw new Error("Cannot find module '"+l+"'")}var i=ht[l]={exports:{}};I[l][0].call(i.exports,function(s){var a=I[l][1][s];return e(a||s)},i,i.exports,v,I,ht,p)}return ht[l].exports}for(var n=typeof xe=="function"&&xe,r=0;r<p.length;r++)e(p[r]);return e}({1:[function(v,I,ht){I.exports={name:"cannon",version:"0.6.2",description:"A lightweight 3D physics engine written in JavaScript.",homepage:"https://github.com/schteppe/cannon.js",author:"Stefan Hedman <schteppe@gmail.com> (http://steffe.se)",keywords:["cannon.js","cannon","physics","engine","3d"],main:"./build/cannon.js",engines:{node:"*"},repository:{type:"git",url:"https://github.com/schteppe/cannon.js.git"},bugs:{url:"https://github.com/schteppe/cannon.js/issues"},licenses:[{type:"MIT"}],devDependencies:{jshint:"latest","uglify-js":"latest",nodeunit:"^0.9.0",grunt:"~0.4.0","grunt-contrib-jshint":"~0.1.1","grunt-contrib-nodeunit":"^0.4.1","grunt-contrib-concat":"~0.1.3","grunt-contrib-uglify":"^0.5.1","grunt-browserify":"^2.1.4","grunt-contrib-yuidoc":"^0.5.2",browserify:"*"},dependencies:{}}},{}],2:[function(v,I,ht){I.exports={version:v("../package.json").version,AABB:v("./collision/AABB"),ArrayCollisionMatrix:v("./collision/ArrayCollisionMatrix"),Body:v("./objects/Body"),Box:v("./shapes/Box"),Broadphase:v("./collision/Broadphase"),Constraint:v("./constraints/Constraint"),ContactEquation:v("./equations/ContactEquation"),Narrowphase:v("./world/Narrowphase"),ConeTwistConstraint:v("./constraints/ConeTwistConstraint"),ContactMaterial:v("./material/ContactMaterial"),ConvexPolyhedron:v("./shapes/ConvexPolyhedron"),Cylinder:v("./shapes/Cylinder"),DistanceConstraint:v("./constraints/DistanceConstraint"),Equation:v("./equations/Equation"),EventTarget:v("./utils/EventTarget"),FrictionEquation:v("./equations/FrictionEquation"),GSSolver:v("./solver/GSSolver"),GridBroadphase:v("./collision/GridBroadphase"),Heightfield:v("./shapes/Heightfield"),HingeConstraint:v("./constraints/HingeConstraint"),LockConstraint:v("./constraints/LockConstraint"),Mat3:v("./math/Mat3"),Material:v("./material/Material"),NaiveBroadphase:v("./collision/NaiveBroadphase"),ObjectCollisionMatrix:v("./collision/ObjectCollisionMatrix"),Pool:v("./utils/Pool"),Particle:v("./shapes/Particle"),Plane:v("./shapes/Plane"),PointToPointConstraint:v("./constraints/PointToPointConstraint"),Quaternion:v("./math/Quaternion"),Ray:v("./collision/Ray"),RaycastVehicle:v("./objects/RaycastVehicle"),RaycastResult:v("./collision/RaycastResult"),RigidVehicle:v("./objects/RigidVehicle"),RotationalEquation:v("./equations/RotationalEquation"),RotationalMotorEquation:v("./equations/RotationalMotorEquation"),SAPBroadphase:v("./collision/SAPBroadphase"),SPHSystem:v("./objects/SPHSystem"),Shape:v("./shapes/Shape"),Solver:v("./solver/Solver"),Sphere:v("./shapes/Sphere"),SplitSolver:v("./solver/SplitSolver"),Spring:v("./objects/Spring"),Trimesh:v("./shapes/Trimesh"),Vec3:v("./math/Vec3"),Vec3Pool:v("./utils/Vec3Pool"),World:v("./world/World")}},{"../package.json":1,"./collision/AABB":3,"./collision/ArrayCollisionMatrix":4,"./collision/Broadphase":5,"./collision/GridBroadphase":6,"./collision/NaiveBroadphase":7,"./collision/ObjectCollisionMatrix":8,"./collision/Ray":9,"./collision/RaycastResult":10,"./collision/SAPBroadphase":11,"./constraints/ConeTwistConstraint":12,"./constraints/Constraint":13,"./constraints/DistanceConstraint":14,"./constraints/HingeConstraint":15,"./constraints/LockConstraint":16,"./constraints/PointToPointConstraint":17,"./equations/ContactEquation":19,"./equations/Equation":20,"./equations/FrictionEquation":21,"./equations/RotationalEquation":22,"./equations/RotationalMotorEquation":23,"./material/ContactMaterial":24,"./material/Material":25,"./math/Mat3":27,"./math/Quaternion":28,"./math/Vec3":30,"./objects/Body":31,"./objects/RaycastVehicle":32,"./objects/RigidVehicle":33,"./objects/SPHSystem":34,"./objects/Spring":35,"./shapes/Box":37,"./shapes/ConvexPolyhedron":38,"./shapes/Cylinder":39,"./shapes/Heightfield":40,"./shapes/Particle":41,"./shapes/Plane":42,"./shapes/Shape":43,"./shapes/Sphere":44,"./shapes/Trimesh":45,"./solver/GSSolver":46,"./solver/Solver":47,"./solver/SplitSolver":48,"./utils/EventTarget":49,"./utils/Pool":51,"./utils/Vec3Pool":54,"./world/Narrowphase":55,"./world/World":56}],3:[function(v,I,ht){var p=v("../math/Vec3");v("../utils/Utils"),I.exports=e;function e(l){l=l||{},this.lowerBound=new p,l.lowerBound&&this.lowerBound.copy(l.lowerBound),this.upperBound=new p,l.upperBound&&this.upperBound.copy(l.upperBound)}var n=new p;e.prototype.setFromPoints=function(l,o,t,i){var s=this.lowerBound,a=this.upperBound,c=t;s.copy(l[0]),c&&c.vmult(s,s),a.copy(s);for(var h=1;h<l.length;h++){var u=l[h];c&&(c.vmult(u,n),u=n),u.x>a.x&&(a.x=u.x),u.x<s.x&&(s.x=u.x),u.y>a.y&&(a.y=u.y),u.y<s.y&&(s.y=u.y),u.z>a.z&&(a.z=u.z),u.z<s.z&&(s.z=u.z)}return o&&(o.vadd(s,s),o.vadd(a,a)),i&&(s.x-=i,s.y-=i,s.z-=i,a.x+=i,a.y+=i,a.z+=i),this},e.prototype.copy=function(l){return this.lowerBound.copy(l.lowerBound),this.upperBound.copy(l.upperBound),this},e.prototype.clone=function(){return new e().copy(this)},e.prototype.extend=function(l){var o=l.lowerBound.x;this.lowerBound.x>o&&(this.lowerBound.x=o);var t=l.upperBound.x;this.upperBound.x<t&&(this.upperBound.x=t);var o=l.lowerBound.y;this.lowerBound.y>o&&(this.lowerBound.y=o);var t=l.upperBound.y;this.upperBound.y<t&&(this.upperBound.y=t);var o=l.lowerBound.z;this.lowerBound.z>o&&(this.lowerBound.z=o);var t=l.upperBound.z;this.upperBound.z<t&&(this.upperBound.z=t)},e.prototype.overlaps=function(l){var o=this.lowerBound,t=this.upperBound,i=l.lowerBound,s=l.upperBound;return(i.x<=t.x&&t.x<=s.x||o.x<=s.x&&s.x<=t.x)&&(i.y<=t.y&&t.y<=s.y||o.y<=s.y&&s.y<=t.y)&&(i.z<=t.z&&t.z<=s.z||o.z<=s.z&&s.z<=t.z)},e.prototype.contains=function(l){var o=this.lowerBound,t=this.upperBound,i=l.lowerBound,s=l.upperBound;return o.x<=i.x&&t.x>=s.x&&o.y<=i.y&&t.y>=s.y&&o.z<=i.z&&t.z>=s.z},e.prototype.getCorners=function(l,o,t,i,s,a,c,h){var u=this.lowerBound,f=this.upperBound;l.copy(u),o.set(f.x,u.y,u.z),t.set(f.x,f.y,u.z),i.set(u.x,f.y,f.z),s.set(f.x,u.y,u.z),a.set(u.x,f.y,u.z),c.set(u.x,u.y,f.z),h.copy(f)};var r=[new p,new p,new p,new p,new p,new p,new p,new p];e.prototype.toLocalFrame=function(l,o){var t=r,i=t[0],s=t[1],a=t[2],c=t[3],h=t[4],u=t[5],f=t[6],w=t[7];this.getCorners(i,s,a,c,h,u,f,w);for(var d=0;d!==8;d++){var b=t[d];l.pointToLocal(b,b)}return o.setFromPoints(t)},e.prototype.toWorldFrame=function(l,o){var t=r,i=t[0],s=t[1],a=t[2],c=t[3],h=t[4],u=t[5],f=t[6],w=t[7];this.getCorners(i,s,a,c,h,u,f,w);for(var d=0;d!==8;d++){var b=t[d];l.pointToWorld(b,b)}return o.setFromPoints(t)}},{"../math/Vec3":30,"../utils/Utils":53}],4:[function(v,I,ht){I.exports=p;function p(){this.matrix=[]}p.prototype.get=function(e,n){if(e=e.index,n=n.index,n>e){var r=n;n=e,e=r}return this.matrix[(e*(e+1)>>1)+n-1]},p.prototype.set=function(e,n,r){if(e=e.index,n=n.index,n>e){var l=n;n=e,e=l}this.matrix[(e*(e+1)>>1)+n-1]=r?1:0},p.prototype.reset=function(){for(var e=0,n=this.matrix.length;e!==n;e++)this.matrix[e]=0},p.prototype.setNumObjects=function(e){this.matrix.length=e*(e-1)>>1}},{}],5:[function(v,I,ht){var p=v("../objects/Body"),e=v("../math/Vec3"),n=v("../math/Quaternion");v("../shapes/Shape"),v("../shapes/Plane"),I.exports=r;function r(){this.world=null,this.useBoundingBoxes=!1,this.dirty=!0}r.prototype.collisionPairs=function(c,h,u){throw new Error("collisionPairs not implemented for this BroadPhase class!")};var l=p.STATIC|p.KINEMATIC;r.prototype.needBroadphaseCollision=function(c,h){return!((c.collisionFilterGroup&h.collisionFilterMask)==0||(h.collisionFilterGroup&c.collisionFilterMask)==0||((c.type&l)!=0||c.sleepState===p.SLEEPING)&&((h.type&l)!=0||h.sleepState===p.SLEEPING))},r.prototype.intersectionTest=function(c,h,u,f){this.useBoundingBoxes?this.doBoundingBoxBroadphase(c,h,u,f):this.doBoundingSphereBroadphase(c,h,u,f)};var o=new e;new e,new n,new e,r.prototype.doBoundingSphereBroadphase=function(c,h,u,f){var w=o;h.position.vsub(c.position,w);var d=Math.pow(c.boundingRadius+h.boundingRadius,2),b=w.norm2();b<d&&(u.push(c),f.push(h))},r.prototype.doBoundingBoxBroadphase=function(c,h,u,f){c.aabbNeedsUpdate&&c.computeAABB(),h.aabbNeedsUpdate&&h.computeAABB(),c.aabb.overlaps(h.aabb)&&(u.push(c),f.push(h))};var t={keys:[]},i=[],s=[];r.prototype.makePairsUnique=function(c,h){for(var u=t,f=i,w=s,d=c.length,b=0;b!==d;b++)f[b]=c[b],w[b]=h[b];c.length=0,h.length=0;for(var b=0;b!==d;b++){var k=f[b].id,at=w[b].id,T=k<at?k+","+at:at+","+k;u[T]=b,u.keys.push(T)}for(var b=0;b!==u.keys.length;b++){var T=u.keys.pop(),H=u[T];c.push(f[H]),h.push(w[H]),delete u[T]}},r.prototype.setWorld=function(c){};var a=new e;r.boundingSphereCheck=function(c,h){var u=a;return c.position.vsub(h.position,u),Math.pow(c.shape.boundingSphereRadius+h.shape.boundingSphereRadius,2)>u.norm2()},r.prototype.aabbQuery=function(c,h,u){return console.warn(".aabbQuery is not implemented in this Broadphase subclass."),[]}},{"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Plane":42,"../shapes/Shape":43}],6:[function(v,I,ht){I.exports=r;var p=v("./Broadphase"),e=v("../math/Vec3"),n=v("../shapes/Shape");function r(o,t,i,s,a){p.apply(this),this.nx=i||10,this.ny=s||10,this.nz=a||10,this.aabbMin=o||new e(100,100,100),this.aabbMax=t||new e(-100,-100,-100);var c=this.nx*this.ny*this.nz;if(c<=0)throw"GridBroadphase: Each dimension's n must be >0";this.bins=[],this.binLengths=[],this.bins.length=c,this.binLengths.length=c;for(var h=0;h<c;h++)this.bins[h]=[],this.binLengths[h]=0}r.prototype=new p,r.prototype.constructor=r;var l=new e;new e,r.prototype.collisionPairs=function(o,t,i){var s=o.numObjects(),a=o.bodies,c=this.aabbMax,h=this.aabbMin,u=this.nx,f=this.ny,w=this.nz,d=f*w,b=w,k=1,at=c.x,T=c.y,H=c.z,z=h.x,B=h.y,R=h.z,D=u/(at-z),$=f/(T-B),K=w/(H-R),ut=(at-z)/u,M=(T-B)/f,E=(H-R)/w,_=Math.sqrt(ut*ut+M*M+E*E)*.5,L=n.types,g=L.SPHERE,P=L.PLANE;L.BOX,L.COMPOUND,L.CONVEXPOLYHEDRON;for(var x=this.bins,m=this.binLengths,y=this.bins.length,A=0;A!==y;A++)m[A]=0;var O=Math.ceil,h=Math.min,c=Math.max;function N(oe,he,re,te,Qt,ue,ce){var ee=(oe-z)*D|0,Jt=(he-B)*$|0,Yt=(re-R)*K|0,ie=O((te-z)*D),$t=O((Qt-B)*$),Gt=O((ue-R)*K);ee<0?ee=0:ee>=u&&(ee=u-1),Jt<0?Jt=0:Jt>=f&&(Jt=f-1),Yt<0?Yt=0:Yt>=w&&(Yt=w-1),ie<0?ie=0:ie>=u&&(ie=u-1),$t<0?$t=0:$t>=f&&($t=f-1),Gt<0?Gt=0:Gt>=w&&(Gt=w-1),ee*=d,Jt*=b,Yt*=k,ie*=d,$t*=b,Gt*=k;for(var pe=ee;pe<=ie;pe+=d)for(var ve=Jt;ve<=$t;ve+=b)for(var fe=Yt;fe<=Gt;fe+=k){var me=pe+ve+fe;x[me][m[me]++]=ce}}for(var A=0;A!==s;A++){var C=a[A],W=C.shape;switch(W.type){case g:var X=C.position.x,ct=C.position.y,st=C.position.z,nt=W.radius;N(X-nt,ct-nt,st-nt,X+nt,ct+nt,st+nt,C);break;case P:W.worldNormalNeedsUpdate&&W.computeWorldNormal(C.quaternion);var q=W.worldNormal,Q=z+ut*.5-C.position.x,Ct=B+M*.5-C.position.y,dt=R+E*.5-C.position.z,Mt=l;Mt.set(Q,Ct,dt);for(var vt=0,At=0;vt!==u;vt++,At+=d,Mt.y=Ct,Mt.x+=ut)for(var gt=0,zt=0;gt!==f;gt++,zt+=b,Mt.z=dt,Mt.y+=M)for(var Vt=0,St=0;Vt!==w;Vt++,St+=k,Mt.z+=E)if(Mt.dot(q)<_){var Nt=At+zt+St;x[Nt][m[Nt]++]=C}break;default:C.aabbNeedsUpdate&&C.computeAABB(),N(C.aabb.lowerBound.x,C.aabb.lowerBound.y,C.aabb.lowerBound.z,C.aabb.upperBound.x,C.aabb.upperBound.y,C.aabb.upperBound.z,C);break}}for(var A=0;A!==y;A++){var qt=m[A];if(qt>1)for(var Et=x[A],vt=0;vt!==qt;vt++)for(var C=Et[vt],gt=0;gt!==vt;gt++){var kt=Et[gt];this.needBroadphaseCollision(C,kt)&&this.intersectionTest(C,kt,t,i)}}this.makePairsUnique(t,i)}},{"../math/Vec3":30,"../shapes/Shape":43,"./Broadphase":5}],7:[function(v,I,ht){I.exports=n;var p=v("./Broadphase"),e=v("./AABB");function n(){p.apply(this)}n.prototype=new p,n.prototype.constructor=n,n.prototype.collisionPairs=function(r,l,o){var t=r.bodies,i=t.length,s,a,c,h;for(s=0;s!==i;s++)for(a=0;a!==s;a++)c=t[s],h=t[a],!!this.needBroadphaseCollision(c,h)&&this.intersectionTest(c,h,l,o)},new e,n.prototype.aabbQuery=function(r,l,o){o=o||[];for(var t=0;t<r.bodies.length;t++){var i=r.bodies[t];i.aabbNeedsUpdate&&i.computeAABB(),i.aabb.overlaps(l)&&o.push(i)}return o}},{"./AABB":3,"./Broadphase":5}],8:[function(v,I,ht){I.exports=p;function p(){this.matrix={}}p.prototype.get=function(e,n){if(e=e.id,n=n.id,n>e){var r=n;n=e,e=r}return e+"-"+n in this.matrix},p.prototype.set=function(e,n,r){if(e=e.id,n=n.id,n>e){var l=n;n=e,e=l}r?this.matrix[e+"-"+n]=!0:delete this.matrix[e+"-"+n]},p.prototype.reset=function(){this.matrix={}},p.prototype.setNumObjects=function(e){}},{}],9:[function(v,I,ht){I.exports=t;var p=v("../math/Vec3"),e=v("../math/Quaternion"),n=v("../math/Transform");v("../shapes/ConvexPolyhedron"),v("../shapes/Box");var r=v("../collision/RaycastResult"),l=v("../shapes/Shape"),o=v("../collision/AABB");function t(x,m){this.from=x?x.clone():new p,this.to=m?m.clone():new p,this._direction=new p,this.precision=1e-4,this.checkCollisionResponse=!0,this.skipBackfaces=!1,this.collisionFilterMask=-1,this.collisionFilterGroup=-1,this.mode=t.ANY,this.result=new r,this.hasHit=!1,this.callback=function(y){}}t.prototype.constructor=t,t.CLOSEST=1,t.ANY=2,t.ALL=4;var i=new o,s=[];t.prototype.intersectWorld=function(x,m){return this.mode=m.mode||t.ANY,this.result=m.result||new r,this.skipBackfaces=!!m.skipBackfaces,this.collisionFilterMask=typeof m.collisionFilterMask!="undefined"?m.collisionFilterMask:-1,this.collisionFilterGroup=typeof m.collisionFilterGroup!="undefined"?m.collisionFilterGroup:-1,m.from&&this.from.copy(m.from),m.to&&this.to.copy(m.to),this.callback=m.callback||function(){},this.hasHit=!1,this.result.reset(),this._updateDirection(),this.getAABB(i),s.length=0,x.broadphase.aabbQuery(x,i,s),this.intersectBodies(s),this.hasHit};var a=new p,c=new p;t.pointInTriangle=h;function h(x,m,y,A){A.vsub(m,L),y.vsub(m,a),x.vsub(m,c);var O=L.dot(L),N=L.dot(a),C=L.dot(c),W=a.dot(a),X=a.dot(c),ct,st;return(ct=W*C-N*X)>=0&&(st=O*X-N*C)>=0&&ct+st<O*W-N*N}var u=new p,f=new e;t.prototype.intersectBody=function(x,m){m&&(this.result=m,this._updateDirection());var y=this.checkCollisionResponse;if(!(y&&!x.collisionResponse)&&!((this.collisionFilterGroup&x.collisionFilterMask)==0||(x.collisionFilterGroup&this.collisionFilterMask)==0))for(var A=u,O=f,N=0,C=x.shapes.length;N<C;N++){var W=x.shapes[N];if(!(y&&!W.collisionResponse)&&(x.quaternion.mult(x.shapeOrientations[N],O),x.quaternion.vmult(x.shapeOffsets[N],A),A.vadd(x.position,A),this.intersectShape(W,O,A,x),this.result._shouldStop))break}},t.prototype.intersectBodies=function(x,m){m&&(this.result=m,this._updateDirection());for(var y=0,A=x.length;!this.result._shouldStop&&y<A;y++)this.intersectBody(x[y])},t.prototype._updateDirection=function(){this.to.vsub(this.from,this._direction),this._direction.normalize()},t.prototype.intersectShape=function(x,m,y,A){var O=this.from,N=P(O,this._direction,y);if(!(N>x.boundingSphereRadius)){var C=this[x.type];C&&C.call(this,x,m,y,A)}},new p,new p;var w=new p,d=new p,b=new p,k=new p;new p,new r,t.prototype.intersectBox=function(x,m,y,A){return this.intersectConvex(x.convexPolyhedronRepresentation,m,y,A)},t.prototype[l.types.BOX]=t.prototype.intersectBox,t.prototype.intersectPlane=function(x,m,y,A){var O=this.from,N=this.to,C=this._direction,W=new p(0,0,1);m.vmult(W,W);var X=new p;O.vsub(y,X);var ct=X.dot(W);N.vsub(y,X);var st=X.dot(W);if(!(ct*st>0)&&!(O.distanceTo(N)<ct)){var nt=W.dot(C);if(!(Math.abs(nt)<this.precision)){var q=new p,Q=new p,Ct=new p;O.vsub(y,q);var dt=-W.dot(q)/nt;C.scale(dt,Q),O.vadd(Q,Ct),this.reportIntersection(W,Ct,x,A,-1)}}},t.prototype[l.types.PLANE]=t.prototype.intersectPlane,t.prototype.getAABB=function(x){var m=this.to,y=this.from;x.lowerBound.x=Math.min(m.x,y.x),x.lowerBound.y=Math.min(m.y,y.y),x.lowerBound.z=Math.min(m.z,y.z),x.upperBound.x=Math.max(m.x,y.x),x.upperBound.y=Math.max(m.y,y.y),x.upperBound.z=Math.max(m.z,y.z)};var at={faceList:[0]};t.prototype.intersectHeightfield=function(x,m,y,A){x.data,x.elementSize;var O=new p,N=new t(this.from,this.to);n.pointToLocalFrame(y,m,N.from,N.from),n.pointToLocalFrame(y,m,N.to,N.to);var C=[],W=null,X=null,ct=null,st=null,nt=x.getIndexOfPosition(N.from.x,N.from.y,C,!1);if(nt&&(W=C[0],X=C[1],ct=C[0],st=C[1]),nt=x.getIndexOfPosition(N.to.x,N.to.y,C,!1),nt&&((W===null||C[0]<W)&&(W=C[0]),(ct===null||C[0]>ct)&&(ct=C[0]),(X===null||C[1]<X)&&(X=C[1]),(st===null||C[1]>st)&&(st=C[1])),W!==null){var q=[];x.getRectMinMax(W,X,ct,st,q),q[0],q[1];for(var Q=W;Q<=ct;Q++)for(var Ct=X;Ct<=st;Ct++){if(this.result._shouldStop||(x.getConvexTrianglePillar(Q,Ct,!1),n.pointToWorldFrame(y,m,x.pillarOffset,O),this.intersectConvex(x.pillarConvex,m,O,A,at),this.result._shouldStop))return;x.getConvexTrianglePillar(Q,Ct,!0),n.pointToWorldFrame(y,m,x.pillarOffset,O),this.intersectConvex(x.pillarConvex,m,O,A,at)}}},t.prototype[l.types.HEIGHTFIELD]=t.prototype.intersectHeightfield;var T=new p,H=new p;t.prototype.intersectSphere=function(x,m,y,A){var O=this.from,N=this.to,C=x.radius,W=Math.pow(N.x-O.x,2)+Math.pow(N.y-O.y,2)+Math.pow(N.z-O.z,2),X=2*((N.x-O.x)*(O.x-y.x)+(N.y-O.y)*(O.y-y.y)+(N.z-O.z)*(O.z-y.z)),ct=Math.pow(O.x-y.x,2)+Math.pow(O.y-y.y,2)+Math.pow(O.z-y.z,2)-Math.pow(C,2),st=Math.pow(X,2)-4*W*ct,nt=T,q=H;if(!(st<0))if(st===0)O.lerp(N,st,nt),nt.vsub(y,q),q.normalize(),this.reportIntersection(q,nt,x,A,-1);else{var Q=(-X-Math.sqrt(st))/(2*W),Ct=(-X+Math.sqrt(st))/(2*W);if(Q>=0&&Q<=1&&(O.lerp(N,Q,nt),nt.vsub(y,q),q.normalize(),this.reportIntersection(q,nt,x,A,-1)),this.result._shouldStop)return;Ct>=0&&Ct<=1&&(O.lerp(N,Ct,nt),nt.vsub(y,q),q.normalize(),this.reportIntersection(q,nt,x,A,-1))}},t.prototype[l.types.SPHERE]=t.prototype.intersectSphere;var z=new p;new p,new p;var B=new p;t.prototype.intersectConvex=function(m,y,A,O,N){for(var C=z,W=B,X=N&&N.faceList||null,ct=m.faces,st=m.vertices,nt=m.faceNormals,q=this._direction,Q=this.from,Ct=this.to,dt=Q.distanceTo(Ct),Mt=X?X.length:ct.length,vt=this.result,At=0;!vt._shouldStop&&At<Mt;At++){var gt=X?X[At]:At,zt=ct[gt],Vt=nt[gt],St=y,Nt=A;W.copy(st[zt[0]]),St.vmult(W,W),W.vadd(Nt,W),W.vsub(Q,W),St.vmult(Vt,C);var qt=q.dot(C);if(!(Math.abs(qt)<this.precision)){var Et=C.dot(W)/qt;if(!(Et<0)){q.mult(Et,w),w.vadd(Q,w),d.copy(st[zt[0]]),St.vmult(d,d),Nt.vadd(d,d);for(var kt=1;!vt._shouldStop&&kt<zt.length-1;kt++){b.copy(st[zt[kt]]),k.copy(st[zt[kt+1]]),St.vmult(b,b),St.vmult(k,k),Nt.vadd(b,b),Nt.vadd(k,k);var oe=w.distanceTo(Q);!(h(w,d,b,k)||h(w,b,d,k))||oe>dt||this.reportIntersection(C,w,m,O,gt)}}}}},t.prototype[l.types.CONVEXPOLYHEDRON]=t.prototype.intersectConvex;var R=new p,D=new p,$=new p,K=new p,ut=new p,M=new p;new o;var E=[],_=new n;t.prototype.intersectTrimesh=function(m,y,A,O,N){var C=R,W=E,X=_,ct=B,st=D,nt=$,q=K,Q=M,Ct=ut;N&&N.faceList;var dt=m.indices;m.vertices,m.faceNormals;var Mt=this.from,vt=this.to,At=this._direction;X.position.copy(A),X.quaternion.copy(y),n.vectorToLocalFrame(A,y,At,st),n.pointToLocalFrame(A,y,Mt,nt),n.pointToLocalFrame(A,y,vt,q);var gt=nt.distanceSquared(q);m.tree.rayQuery(this,X,W);for(var zt=0,Vt=W.length;!this.result._shouldStop&&zt!==Vt;zt++){var St=W[zt];m.getNormal(St,C),m.getVertex(dt[St*3],d),d.vsub(nt,ct);var Nt=st.dot(C),qt=C.dot(ct)/Nt;if(!(qt<0)){st.scale(qt,w),w.vadd(nt,w),m.getVertex(dt[St*3+1],b),m.getVertex(dt[St*3+2],k);var Et=w.distanceSquared(nt);!(h(w,b,d,k)||h(w,d,b,k))||Et>gt||(n.vectorToWorldFrame(y,C,Ct),n.pointToWorldFrame(A,y,w,Q),this.reportIntersection(Ct,Q,m,O,St))}}W.length=0},t.prototype[l.types.TRIMESH]=t.prototype.intersectTrimesh,t.prototype.reportIntersection=function(x,m,y,A,O){var N=this.from,C=this.to,W=N.distanceTo(m),X=this.result;if(!(this.skipBackfaces&&x.dot(this._direction)>0))switch(X.hitFaceIndex=typeof O!="undefined"?O:-1,this.mode){case t.ALL:this.hasHit=!0,X.set(N,C,x,m,y,A,W),X.hasHit=!0,this.callback(X);break;case t.CLOSEST:(W<X.distance||!X.hasHit)&&(this.hasHit=!0,X.hasHit=!0,X.set(N,C,x,m,y,A,W));break;case t.ANY:this.hasHit=!0,X.hasHit=!0,X.set(N,C,x,m,y,A,W),X._shouldStop=!0;break}};var L=new p,g=new p;function P(x,m,y){y.vsub(x,L);var A=L.dot(m);m.mult(A,g),g.vadd(x,g);var O=y.distanceTo(g);return O}},{"../collision/AABB":3,"../collision/RaycastResult":10,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../shapes/Box":37,"../shapes/ConvexPolyhedron":38,"../shapes/Shape":43}],10:[function(v,I,ht){var p=v("../math/Vec3");I.exports=e;function e(){this.rayFromWorld=new p,this.rayToWorld=new p,this.hitNormalWorld=new p,this.hitPointWorld=new p,this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1}e.prototype.reset=function(){this.rayFromWorld.setZero(),this.rayToWorld.setZero(),this.hitNormalWorld.setZero(),this.hitPointWorld.setZero(),this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1},e.prototype.abort=function(){this._shouldStop=!0},e.prototype.set=function(n,r,l,o,t,i,s){this.rayFromWorld.copy(n),this.rayToWorld.copy(r),this.hitNormalWorld.copy(l),this.hitPointWorld.copy(o),this.shape=t,this.body=i,this.distance=s}},{"../math/Vec3":30}],11:[function(v,I,ht){v("../shapes/Shape");var p=v("../collision/Broadphase");I.exports=e;function e(n){p.apply(this),this.axisList=[],this.world=null,this.axisIndex=0;var r=this.axisList;this._addBodyHandler=function(l){r.push(l.body)},this._removeBodyHandler=function(l){var o=r.indexOf(l.body);o!==-1&&r.splice(o,1)},n&&this.setWorld(n)}e.prototype=new p,e.prototype.setWorld=function(n){this.axisList.length=0;for(var r=0;r<n.bodies.length;r++)this.axisList.push(n.bodies[r]);n.removeEventListener("addBody",this._addBodyHandler),n.removeEventListener("removeBody",this._removeBodyHandler),n.addEventListener("addBody",this._addBodyHandler),n.addEventListener("removeBody",this._removeBodyHandler),this.world=n,this.dirty=!0},e.insertionSortX=function(n){for(var r=1,l=n.length;r<l;r++){for(var o=n[r],t=r-1;t>=0&&!(n[t].aabb.lowerBound.x<=o.aabb.lowerBound.x);t--)n[t+1]=n[t];n[t+1]=o}return n},e.insertionSortY=function(n){for(var r=1,l=n.length;r<l;r++){for(var o=n[r],t=r-1;t>=0&&!(n[t].aabb.lowerBound.y<=o.aabb.lowerBound.y);t--)n[t+1]=n[t];n[t+1]=o}return n},e.insertionSortZ=function(n){for(var r=1,l=n.length;r<l;r++){for(var o=n[r],t=r-1;t>=0&&!(n[t].aabb.lowerBound.z<=o.aabb.lowerBound.z);t--)n[t+1]=n[t];n[t+1]=o}return n},e.prototype.collisionPairs=function(n,r,l){var o=this.axisList,t=o.length,i=this.axisIndex,s,a;for(this.dirty&&(this.sortList(),this.dirty=!1),s=0;s!==t;s++){var c=o[s];for(a=s+1;a<t;a++){var h=o[a];if(!!this.needBroadphaseCollision(c,h)){if(!e.checkBounds(c,h,i))break;this.intersectionTest(c,h,r,l)}}}},e.prototype.sortList=function(){for(var n=this.axisList,r=this.axisIndex,l=n.length,o=0;o!==l;o++){var t=n[o];t.aabbNeedsUpdate&&t.computeAABB()}r===0?e.insertionSortX(n):r===1?e.insertionSortY(n):r===2&&e.insertionSortZ(n)},e.checkBounds=function(n,r,l){var o,t;l===0?(o=n.position.x,t=r.position.x):l===1?(o=n.position.y,t=r.position.y):l===2&&(o=n.position.z,t=r.position.z);var i=n.boundingRadius,s=r.boundingRadius,a=o+i,c=t-s;return c<a},e.prototype.autoDetectAxis=function(){for(var n=0,r=0,l=0,o=0,t=0,i=0,s=this.axisList,a=s.length,c=1/a,h=0;h!==a;h++){var u=s[h],f=u.position.x;n+=f,r+=f*f;var w=u.position.y;l+=w,o+=w*w;var d=u.position.z;t+=d,i+=d*d}var b=r-n*n*c,k=o-l*l*c,at=i-t*t*c;b>k?b>at?this.axisIndex=0:this.axisIndex=2:k>at?this.axisIndex=1:this.axisIndex=2},e.prototype.aabbQuery=function(n,r,l){l=l||[],this.dirty&&(this.sortList(),this.dirty=!1);var o=this.axisIndex,t="x";o===1&&(t="y"),o===2&&(t="z");var i=this.axisList;r.lowerBound[t],r.upperBound[t];for(var s=0;s<i.length;s++){var a=i[s];a.aabbNeedsUpdate&&a.computeAABB(),a.aabb.overlaps(r)&&l.push(a)}return l}},{"../collision/Broadphase":5,"../shapes/Shape":43}],12:[function(v,I,ht){I.exports=l,v("./Constraint");var p=v("./PointToPointConstraint"),e=v("../equations/ConeEquation"),n=v("../equations/RotationalEquation");v("../equations/ContactEquation");var r=v("../math/Vec3");function l(o,t,i){i=i||{};var s=typeof i.maxForce!="undefined"?i.maxForce:1e6,a=i.pivotA?i.pivotA.clone():new r,c=i.pivotB?i.pivotB.clone():new r;this.axisA=i.axisA?i.axisA.clone():new r,this.axisB=i.axisB?i.axisB.clone():new r,p.call(this,o,a,t,c,s),this.collideConnected=!!i.collideConnected,this.angle=typeof i.angle!="undefined"?i.angle:0;var h=this.coneEquation=new e(o,t,i),u=this.twistEquation=new n(o,t,i);this.twistAngle=typeof i.twistAngle!="undefined"?i.twistAngle:0,h.maxForce=0,h.minForce=-s,u.maxForce=0,u.minForce=-s,this.equations.push(h,u)}l.prototype=new p,l.constructor=l,new r,new r,l.prototype.update=function(){var o=this.bodyA,t=this.bodyB,i=this.coneEquation,s=this.twistEquation;p.prototype.update.call(this),o.vectorToWorldFrame(this.axisA,i.axisA),t.vectorToWorldFrame(this.axisB,i.axisB),this.axisA.tangents(s.axisA,s.axisA),o.vectorToWorldFrame(s.axisA,s.axisA),this.axisB.tangents(s.axisB,s.axisB),t.vectorToWorldFrame(s.axisB,s.axisB),i.angle=this.angle,s.maxAngle=this.twistAngle}},{"../equations/ConeEquation":18,"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],13:[function(v,I,ht){I.exports=e;var p=v("../utils/Utils");function e(n,r,l){l=p.defaults(l,{collideConnected:!0,wakeUpBodies:!0}),this.equations=[],this.bodyA=n,this.bodyB=r,this.id=e.idCounter++,this.collideConnected=l.collideConnected,l.wakeUpBodies&&(n&&n.wakeUp(),r&&r.wakeUp())}e.prototype.update=function(){throw new Error("method update() not implmemented in this Constraint subclass!")},e.prototype.enable=function(){for(var n=this.equations,r=0;r<n.length;r++)n[r].enabled=!0},e.prototype.disable=function(){for(var n=this.equations,r=0;r<n.length;r++)n[r].enabled=!1},e.idCounter=0},{"../utils/Utils":53}],14:[function(v,I,ht){I.exports=n;var p=v("./Constraint"),e=v("../equations/ContactEquation");function n(r,l,o,t){p.call(this,r,l),typeof o=="undefined"&&(o=r.position.distanceTo(l.position)),typeof t=="undefined"&&(t=1e6),this.distance=o;var i=this.distanceEquation=new e(r,l);this.equations.push(i),i.minForce=-t,i.maxForce=t}n.prototype=new p,n.prototype.update=function(){var r=this.bodyA,l=this.bodyB,o=this.distanceEquation,t=this.distance*.5,i=o.ni;l.position.vsub(r.position,i),i.normalize(),i.mult(t,o.ri),i.mult(-t,o.rj)}},{"../equations/ContactEquation":19,"./Constraint":13}],15:[function(v,I,ht){I.exports=l,v("./Constraint");var p=v("./PointToPointConstraint"),e=v("../equations/RotationalEquation"),n=v("../equations/RotationalMotorEquation");v("../equations/ContactEquation");var r=v("../math/Vec3");function l(i,s,a){a=a||{};var c=typeof a.maxForce!="undefined"?a.maxForce:1e6,h=a.pivotA?a.pivotA.clone():new r,u=a.pivotB?a.pivotB.clone():new r;p.call(this,i,h,s,u,c);var f=this.axisA=a.axisA?a.axisA.clone():new r(1,0,0);f.normalize();var w=this.axisB=a.axisB?a.axisB.clone():new r(1,0,0);w.normalize();var d=this.rotationalEquation1=new e(i,s,a),b=this.rotationalEquation2=new e(i,s,a),k=this.motorEquation=new n(i,s,c);k.enabled=!1,this.equations.push(d,b,k)}l.prototype=new p,l.constructor=l,l.prototype.enableMotor=function(){this.motorEquation.enabled=!0},l.prototype.disableMotor=function(){this.motorEquation.enabled=!1},l.prototype.setMotorSpeed=function(i){this.motorEquation.targetVelocity=i},l.prototype.setMotorMaxForce=function(i){this.motorEquation.maxForce=i,this.motorEquation.minForce=-i};var o=new r,t=new r;l.prototype.update=function(){var i=this.bodyA,s=this.bodyB,a=this.motorEquation,c=this.rotationalEquation1,h=this.rotationalEquation2,u=o,f=t,w=this.axisA,d=this.axisB;p.prototype.update.call(this),i.quaternion.vmult(w,u),s.quaternion.vmult(d,f),u.tangents(c.axisA,h.axisA),c.axisB.copy(f),h.axisB.copy(f),this.motorEquation.enabled&&(i.quaternion.vmult(this.axisA,a.axisA),s.quaternion.vmult(this.axisB,a.axisB))}},{"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../equations/RotationalMotorEquation":23,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],16:[function(v,I,ht){I.exports=r,v("./Constraint");var p=v("./PointToPointConstraint"),e=v("../equations/RotationalEquation");v("../equations/RotationalMotorEquation"),v("../equations/ContactEquation");var n=v("../math/Vec3");function r(l,o,t){t=t||{};var i=typeof t.maxForce!="undefined"?t.maxForce:1e6,s=new n,a=new n,c=new n;l.position.vadd(o.position,c),c.scale(.5,c),o.pointToLocalFrame(c,a),l.pointToLocalFrame(c,s),p.call(this,l,s,o,a,i);var h=this.rotationalEquation1=new e(l,o,t),u=this.rotationalEquation2=new e(l,o,t),f=this.rotationalEquation3=new e(l,o,t);this.equations.push(h,u,f)}r.prototype=new p,r.constructor=r,new n,new n,r.prototype.update=function(){var l=this.bodyA,o=this.bodyB;this.motorEquation;var t=this.rotationalEquation1,i=this.rotationalEquation2,s=this.rotationalEquation3;p.prototype.update.call(this),l.vectorToWorldFrame(n.UNIT_X,t.axisA),o.vectorToWorldFrame(n.UNIT_Y,t.axisB),l.vectorToWorldFrame(n.UNIT_Y,i.axisA),o.vectorToWorldFrame(n.UNIT_Z,i.axisB),l.vectorToWorldFrame(n.UNIT_Z,s.axisA),o.vectorToWorldFrame(n.UNIT_X,s.axisB)}},{"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../equations/RotationalMotorEquation":23,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],17:[function(v,I,ht){I.exports=r;var p=v("./Constraint"),e=v("../equations/ContactEquation"),n=v("../math/Vec3");function r(l,o,t,i,s){p.call(this,l,t),s=typeof s!="undefined"?s:1e6,this.pivotA=o?o.clone():new n,this.pivotB=i?i.clone():new n;var a=this.equationX=new e(l,t),c=this.equationY=new e(l,t),h=this.equationZ=new e(l,t);this.equations.push(a,c,h),a.minForce=c.minForce=h.minForce=-s,a.maxForce=c.maxForce=h.maxForce=s,a.ni.set(1,0,0),c.ni.set(0,1,0),h.ni.set(0,0,1)}r.prototype=new p,r.prototype.update=function(){var l=this.bodyA,o=this.bodyB,t=this.equationX,i=this.equationY,s=this.equationZ;l.quaternion.vmult(this.pivotA,t.ri),o.quaternion.vmult(this.pivotB,t.rj),i.ri.copy(t.ri),i.rj.copy(t.rj),s.ri.copy(t.ri),s.rj.copy(t.rj)}},{"../equations/ContactEquation":19,"../math/Vec3":30,"./Constraint":13}],18:[function(v,I,ht){I.exports=n;var p=v("../math/Vec3");v("../math/Mat3");var e=v("./Equation");function n(o,t,i){i=i||{};var s=typeof i.maxForce!="undefined"?i.maxForce:1e6;e.call(this,o,t,-s,s),this.axisA=i.axisA?i.axisA.clone():new p(1,0,0),this.axisB=i.axisB?i.axisB.clone():new p(0,1,0),this.angle=typeof i.angle!="undefined"?i.angle:0}n.prototype=new e,n.prototype.constructor=n;var r=new p,l=new p;n.prototype.computeB=function(o){var t=this.a,i=this.b,s=this.axisA,a=this.axisB,c=r,h=l,u=this.jacobianElementA,f=this.jacobianElementB;s.cross(a,c),a.cross(s,h),u.rotational.copy(h),f.rotational.copy(c);var w=Math.cos(this.angle)-s.dot(a),d=this.computeGW(),b=this.computeGiMf(),k=-w*t-d*i-o*b;return k}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],19:[function(v,I,ht){I.exports=n;var p=v("./Equation"),e=v("../math/Vec3");v("../math/Mat3");function n(h,u,f){f=typeof f!="undefined"?f:1e6,p.call(this,h,u,0,f),this.restitution=0,this.ri=new e,this.rj=new e,this.ni=new e}n.prototype=new p,n.prototype.constructor=n;var r=new e,l=new e,o=new e;n.prototype.computeB=function(h){var u=this.a,f=this.b,w=this.bi,d=this.bj,b=this.ri,k=this.rj,at=r,T=l,H=w.velocity,z=w.angularVelocity;w.force,w.torque;var B=d.velocity,R=d.angularVelocity;d.force,d.torque;var D=o,$=this.jacobianElementA,K=this.jacobianElementB,ut=this.ni;b.cross(ut,at),k.cross(ut,T),ut.negate($.spatial),at.negate($.rotational),K.spatial.copy(ut),K.rotational.copy(T),D.copy(d.position),D.vadd(k,D),D.vsub(w.position,D),D.vsub(b,D);var M=ut.dot(D),E=this.restitution+1,_=E*B.dot(ut)-E*H.dot(ut)+R.dot(T)-z.dot(at),L=this.computeGiMf(),g=-M*u-_*f-h*L;return g};var t=new e,i=new e,s=new e,a=new e,c=new e;n.prototype.getImpactVelocityAlongNormal=function(){var h=t,u=i,f=s,w=a,d=c;return this.bi.position.vadd(this.ri,f),this.bj.position.vadd(this.rj,w),this.bi.getVelocityAtWorldPoint(f,h),this.bj.getVelocityAtWorldPoint(w,u),h.vsub(u,d),this.ni.dot(d)}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],20:[function(v,I,ht){I.exports=n;var p=v("../math/JacobianElement"),e=v("../math/Vec3");function n(c,h,u,f){this.id=n.id++,this.minForce=typeof u=="undefined"?-1e6:u,this.maxForce=typeof f=="undefined"?1e6:f,this.bi=c,this.bj=h,this.a=0,this.b=0,this.eps=0,this.jacobianElementA=new p,this.jacobianElementB=new p,this.enabled=!0,this.setSpookParams(1e7,4,1/60)}n.prototype.constructor=n,n.id=0,n.prototype.setSpookParams=function(c,h,u){var f=h,w=c,d=u;this.a=4/(d*(1+4*f)),this.b=4*f/(1+4*f),this.eps=4/(d*d*w*(1+4*f))},n.prototype.computeB=function(c,h,u){var f=this.computeGW(),w=this.computeGq(),d=this.computeGiMf();return-w*c-f*h-d*u},n.prototype.computeGq=function(){var c=this.jacobianElementA,h=this.jacobianElementB,u=this.bi,f=this.bj,w=u.position,d=f.position;return c.spatial.dot(w)+h.spatial.dot(d)};var r=new e;n.prototype.computeGW=function(){var c=this.jacobianElementA,h=this.jacobianElementB,u=this.bi,f=this.bj,w=u.velocity,d=f.velocity,b=u.angularVelocity||r,k=f.angularVelocity||r;return c.multiplyVectors(w,b)+h.multiplyVectors(d,k)},n.prototype.computeGWlambda=function(){var c=this.jacobianElementA,h=this.jacobianElementB,u=this.bi,f=this.bj,w=u.vlambda,d=f.vlambda,b=u.wlambda||r,k=f.wlambda||r;return c.multiplyVectors(w,b)+h.multiplyVectors(d,k)};var l=new e,o=new e,t=new e,i=new e;n.prototype.computeGiMf=function(){var c=this.jacobianElementA,h=this.jacobianElementB,u=this.bi,f=this.bj,w=u.force,d=u.torque,b=f.force,k=f.torque,at=u.invMassSolve,T=f.invMassSolve;return u.invInertiaWorldSolve?u.invInertiaWorldSolve.vmult(d,t):t.set(0,0,0),f.invInertiaWorldSolve?f.invInertiaWorldSolve.vmult(k,i):i.set(0,0,0),w.mult(at,l),b.mult(T,o),c.multiplyVectors(l,t)+h.multiplyVectors(o,i)};var s=new e;n.prototype.computeGiMGt=function(){var c=this.jacobianElementA,h=this.jacobianElementB,u=this.bi,f=this.bj,w=u.invMassSolve,d=f.invMassSolve,b=u.invInertiaWorldSolve,k=f.invInertiaWorldSolve,at=w+d;return b&&(b.vmult(c.rotational,s),at+=s.dot(c.rotational)),k&&(k.vmult(h.rotational,s),at+=s.dot(h.rotational)),at};var a=new e;new e,new e,new e,new e,new e,n.prototype.addToWlambda=function(c){var h=this.jacobianElementA,u=this.jacobianElementB,f=this.bi,w=this.bj,d=a;h.spatial.mult(f.invMassSolve*c,d),f.vlambda.vadd(d,f.vlambda),u.spatial.mult(w.invMassSolve*c,d),w.vlambda.vadd(d,w.vlambda),f.invInertiaWorldSolve&&(f.invInertiaWorldSolve.vmult(h.rotational,d),d.mult(c,d),f.wlambda.vadd(d,f.wlambda)),w.invInertiaWorldSolve&&(w.invInertiaWorldSolve.vmult(u.rotational,d),d.mult(c,d),w.wlambda.vadd(d,w.wlambda))},n.prototype.computeC=function(){return this.computeGiMGt()+this.eps}},{"../math/JacobianElement":26,"../math/Vec3":30}],21:[function(v,I,ht){I.exports=n;var p=v("./Equation"),e=v("../math/Vec3");v("../math/Mat3");function n(o,t,i){p.call(this,o,t,-i,i),this.ri=new e,this.rj=new e,this.t=new e}n.prototype=new p,n.prototype.constructor=n;var r=new e,l=new e;n.prototype.computeB=function(o){this.a;var t=this.b;this.bi,this.bj;var i=this.ri,s=this.rj,a=r,c=l,h=this.t;i.cross(h,a),s.cross(h,c);var u=this.jacobianElementA,f=this.jacobianElementB;h.negate(u.spatial),a.negate(u.rotational),f.spatial.copy(h),f.rotational.copy(c);var w=this.computeGW(),d=this.computeGiMf(),b=-w*t-o*d;return b}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],22:[function(v,I,ht){I.exports=n;var p=v("../math/Vec3");v("../math/Mat3");var e=v("./Equation");function n(o,t,i){i=i||{};var s=typeof i.maxForce!="undefined"?i.maxForce:1e6;e.call(this,o,t,-s,s),this.axisA=i.axisA?i.axisA.clone():new p(1,0,0),this.axisB=i.axisB?i.axisB.clone():new p(0,1,0),this.maxAngle=Math.PI/2}n.prototype=new e,n.prototype.constructor=n;var r=new p,l=new p;n.prototype.computeB=function(o){var t=this.a,i=this.b,s=this.axisA,a=this.axisB,c=r,h=l,u=this.jacobianElementA,f=this.jacobianElementB;s.cross(a,c),a.cross(s,h),u.rotational.copy(h),f.rotational.copy(c);var w=Math.cos(this.maxAngle)-s.dot(a),d=this.computeGW(),b=this.computeGiMf(),k=-w*t-d*i-o*b;return k}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],23:[function(v,I,ht){I.exports=n;var p=v("../math/Vec3");v("../math/Mat3");var e=v("./Equation");function n(r,l,o){o=typeof o!="undefined"?o:1e6,e.call(this,r,l,-o,o),this.axisA=new p,this.axisB=new p,this.targetVelocity=0}n.prototype=new e,n.prototype.constructor=n,n.prototype.computeB=function(r){this.a;var l=this.b;this.bi,this.bj;var o=this.axisA,t=this.axisB,i=this.jacobianElementA,s=this.jacobianElementB;i.rotational.copy(o),t.negate(s.rotational);var a=this.computeGW()-this.targetVelocity,c=this.computeGiMf(),h=-a*l-r*c;return h}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],24:[function(v,I,ht){var p=v("../utils/Utils");I.exports=e;function e(n,r,l){l=p.defaults(l,{friction:.3,restitution:.3,contactEquationStiffness:1e7,contactEquationRelaxation:3,frictionEquationStiffness:1e7,frictionEquationRelaxation:3}),this.id=e.idCounter++,this.materials=[n,r],this.friction=l.friction,this.restitution=l.restitution,this.contactEquationStiffness=l.contactEquationStiffness,this.contactEquationRelaxation=l.contactEquationRelaxation,this.frictionEquationStiffness=l.frictionEquationStiffness,this.frictionEquationRelaxation=l.frictionEquationRelaxation}e.idCounter=0},{"../utils/Utils":53}],25:[function(v,I,ht){I.exports=p;function p(e){var n="";e=e||{},typeof e=="string"?(n=e,e={}):typeof e=="object"&&(n=""),this.name=n,this.id=p.idCounter++,this.friction=typeof e.friction!="undefined"?e.friction:-1,this.restitution=typeof e.restitution!="undefined"?e.restitution:-1}p.idCounter=0},{}],26:[function(v,I,ht){I.exports=e;var p=v("./Vec3");function e(){this.spatial=new p,this.rotational=new p}e.prototype.multiplyElement=function(n){return n.spatial.dot(this.spatial)+n.rotational.dot(this.rotational)},e.prototype.multiplyVectors=function(n,r){return n.dot(this.spatial)+r.dot(this.rotational)}},{"./Vec3":30}],27:[function(v,I,ht){I.exports=e;var p=v("./Vec3");function e(n){n?this.elements=n:this.elements=[0,0,0,0,0,0,0,0,0]}e.prototype.identity=function(){var n=this.elements;n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=1,n[5]=0,n[6]=0,n[7]=0,n[8]=1},e.prototype.setZero=function(){var n=this.elements;n[0]=0,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=0,n[6]=0,n[7]=0,n[8]=0},e.prototype.setTrace=function(n){var r=this.elements;r[0]=n.x,r[4]=n.y,r[8]=n.z},e.prototype.getTrace=function(n){var n=n||new p,r=this.elements;n.x=r[0],n.y=r[4],n.z=r[8]},e.prototype.vmult=function(n,r){r=r||new p;var l=this.elements,o=n.x,t=n.y,i=n.z;return r.x=l[0]*o+l[1]*t+l[2]*i,r.y=l[3]*o+l[4]*t+l[5]*i,r.z=l[6]*o+l[7]*t+l[8]*i,r},e.prototype.smult=function(n){for(var r=0;r<this.elements.length;r++)this.elements[r]*=n},e.prototype.mmult=function(n,r){for(var l=r||new e,o=0;o<3;o++)for(var t=0;t<3;t++){for(var i=0,s=0;s<3;s++)i+=n.elements[o+s*3]*this.elements[s+t*3];l.elements[o+t*3]=i}return l},e.prototype.scale=function(n,r){r=r||new e;for(var l=this.elements,o=r.elements,t=0;t!==3;t++)o[3*t+0]=n.x*l[3*t+0],o[3*t+1]=n.y*l[3*t+1],o[3*t+2]=n.z*l[3*t+2];return r},e.prototype.solve=function(n,r){r=r||new p;for(var l=3,o=4,t=[],i=0;i<l*o;i++)t.push(0);var i,s;for(i=0;i<3;i++)for(s=0;s<3;s++)t[i+o*s]=this.elements[i+3*s];t[3+4*0]=n.x,t[3+4*1]=n.y,t[3+4*2]=n.z;var a=3,c=a,h,u=4,f;do{if(i=c-a,t[i+o*i]===0){for(s=i+1;s<c;s++)if(t[i+o*s]!==0){h=u;do f=u-h,t[f+o*i]+=t[f+o*s];while(--h);break}}if(t[i+o*i]!==0)for(s=i+1;s<c;s++){var w=t[i+o*s]/t[i+o*i];h=u;do f=u-h,t[f+o*s]=f<=i?0:t[f+o*s]-t[f+o*i]*w;while(--h)}}while(--a);if(r.z=t[2*o+3]/t[2*o+2],r.y=(t[1*o+3]-t[1*o+2]*r.z)/t[1*o+1],r.x=(t[0*o+3]-t[0*o+2]*r.z-t[0*o+1]*r.y)/t[0*o+0],isNaN(r.x)||isNaN(r.y)||isNaN(r.z)||r.x===1/0||r.y===1/0||r.z===1/0)throw"Could not solve equation! Got x=["+r.toString()+"], b=["+n.toString()+"], A=["+this.toString()+"]";return r},e.prototype.e=function(n,r,l){if(l===void 0)return this.elements[r+3*n];this.elements[r+3*n]=l},e.prototype.copy=function(n){for(var r=0;r<n.elements.length;r++)this.elements[r]=n.elements[r];return this},e.prototype.toString=function(){for(var n="",r=",",l=0;l<9;l++)n+=this.elements[l]+r;return n},e.prototype.reverse=function(n){n=n||new e;for(var r=3,l=6,o=[],t=0;t<r*l;t++)o.push(0);var t,i;for(t=0;t<3;t++)for(i=0;i<3;i++)o[t+l*i]=this.elements[t+3*i];o[3+6*0]=1,o[3+6*1]=0,o[3+6*2]=0,o[4+6*0]=0,o[4+6*1]=1,o[4+6*2]=0,o[5+6*0]=0,o[5+6*1]=0,o[5+6*2]=1;var s=3,a=s,c,h=l,u;do{if(t=a-s,o[t+l*t]===0){for(i=t+1;i<a;i++)if(o[t+l*i]!==0){c=h;do u=h-c,o[u+l*t]+=o[u+l*i];while(--c);break}}if(o[t+l*t]!==0)for(i=t+1;i<a;i++){var f=o[t+l*i]/o[t+l*t];c=h;do u=h-c,o[u+l*i]=u<=t?0:o[u+l*i]-o[u+l*t]*f;while(--c)}}while(--s);t=2;do{i=t-1;do{var f=o[t+l*i]/o[t+l*t];c=l;do u=l-c,o[u+l*i]=o[u+l*i]-o[u+l*t]*f;while(--c)}while(i--)}while(--t);t=2;do{var f=1/o[t+l*t];c=l;do u=l-c,o[u+l*t]=o[u+l*t]*f;while(--c)}while(t--);t=2;do{i=2;do{if(u=o[r+i+l*t],isNaN(u)||u===1/0)throw"Could not reverse! A=["+this.toString()+"]";n.e(t,i,u)}while(i--)}while(t--);return n},e.prototype.setRotationFromQuaternion=function(n){var r=n.x,l=n.y,o=n.z,t=n.w,i=r+r,s=l+l,a=o+o,c=r*i,h=r*s,u=r*a,f=l*s,w=l*a,d=o*a,b=t*i,k=t*s,at=t*a,T=this.elements;return T[3*0+0]=1-(f+d),T[3*0+1]=h-at,T[3*0+2]=u+k,T[3*1+0]=h+at,T[3*1+1]=1-(c+d),T[3*1+2]=w-b,T[3*2+0]=u-k,T[3*2+1]=w+b,T[3*2+2]=1-(c+f),this},e.prototype.transpose=function(n){n=n||new e;for(var r=n.elements,l=this.elements,o=0;o!==3;o++)for(var t=0;t!==3;t++)r[3*o+t]=l[3*t+o];return n}},{"./Vec3":30}],28:[function(v,I,ht){I.exports=e;var p=v("./Vec3");function e(i,s,a,c){this.x=i!==void 0?i:0,this.y=s!==void 0?s:0,this.z=a!==void 0?a:0,this.w=c!==void 0?c:1}e.prototype.set=function(i,s,a,c){this.x=i,this.y=s,this.z=a,this.w=c},e.prototype.toString=function(){return this.x+","+this.y+","+this.z+","+this.w},e.prototype.toArray=function(){return[this.x,this.y,this.z,this.w]},e.prototype.setFromAxisAngle=function(i,s){var a=Math.sin(s*.5);this.x=i.x*a,this.y=i.y*a,this.z=i.z*a,this.w=Math.cos(s*.5)},e.prototype.toAxisAngle=function(i){i=i||new p,this.normalize();var s=2*Math.acos(this.w),a=Math.sqrt(1-this.w*this.w);return a<.001?(i.x=this.x,i.y=this.y,i.z=this.z):(i.x=this.x/a,i.y=this.y/a,i.z=this.z/a),[i,s]};var n=new p,r=new p;e.prototype.setFromVectors=function(i,s){if(i.isAntiparallelTo(s)){var a=n,c=r;i.tangents(a,c),this.setFromAxisAngle(a,Math.PI)}else{var h=i.cross(s);this.x=h.x,this.y=h.y,this.z=h.z,this.w=Math.sqrt(Math.pow(i.norm(),2)*Math.pow(s.norm(),2))+i.dot(s),this.normalize()}};var l=new p,o=new p,t=new p;e.prototype.mult=function(i,s){s=s||new e;var a=this.w,c=l,h=o,u=t;return c.set(this.x,this.y,this.z),h.set(i.x,i.y,i.z),s.w=a*i.w-c.dot(h),c.cross(h,u),s.x=a*h.x+i.w*c.x+u.x,s.y=a*h.y+i.w*c.y+u.y,s.z=a*h.z+i.w*c.z+u.z,s},e.prototype.inverse=function(i){var s=this.x,a=this.y,c=this.z,h=this.w;i=i||new e,this.conjugate(i);var u=1/(s*s+a*a+c*c+h*h);return i.x*=u,i.y*=u,i.z*=u,i.w*=u,i},e.prototype.conjugate=function(i){return i=i||new e,i.x=-this.x,i.y=-this.y,i.z=-this.z,i.w=this.w,i},e.prototype.normalize=function(){var i=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);i===0?(this.x=0,this.y=0,this.z=0,this.w=0):(i=1/i,this.x*=i,this.y*=i,this.z*=i,this.w*=i)},e.prototype.normalizeFast=function(){var i=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;i===0?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=i,this.y*=i,this.z*=i,this.w*=i)},e.prototype.vmult=function(i,s){s=s||new p;var a=i.x,c=i.y,h=i.z,u=this.x,f=this.y,w=this.z,d=this.w,b=d*a+f*h-w*c,k=d*c+w*a-u*h,at=d*h+u*c-f*a,T=-u*a-f*c-w*h;return s.x=b*d+T*-u+k*-w-at*-f,s.y=k*d+T*-f+at*-u-b*-w,s.z=at*d+T*-w+b*-f-k*-u,s},e.prototype.copy=function(i){return this.x=i.x,this.y=i.y,this.z=i.z,this.w=i.w,this},e.prototype.toEuler=function(i,s){s=s||"YZX";var a,c,h,u=this.x,f=this.y,w=this.z,d=this.w;switch(s){case"YZX":var b=u*f+w*d;if(b>.499&&(a=2*Math.atan2(u,d),c=Math.PI/2,h=0),b<-.499&&(a=-2*Math.atan2(u,d),c=-Math.PI/2,h=0),isNaN(a)){var k=u*u,at=f*f,T=w*w;a=Math.atan2(2*f*d-2*u*w,1-2*at-2*T),c=Math.asin(2*b),h=Math.atan2(2*u*d-2*f*w,1-2*k-2*T)}break;default:throw new Error("Euler order "+s+" not supported yet.")}i.y=a,i.z=c,i.x=h},e.prototype.setFromEuler=function(i,s,a,c){c=c||"XYZ";var h=Math.cos(i/2),u=Math.cos(s/2),f=Math.cos(a/2),w=Math.sin(i/2),d=Math.sin(s/2),b=Math.sin(a/2);return c==="XYZ"?(this.x=w*u*f+h*d*b,this.y=h*d*f-w*u*b,this.z=h*u*b+w*d*f,this.w=h*u*f-w*d*b):c==="YXZ"?(this.x=w*u*f+h*d*b,this.y=h*d*f-w*u*b,this.z=h*u*b-w*d*f,this.w=h*u*f+w*d*b):c==="ZXY"?(this.x=w*u*f-h*d*b,this.y=h*d*f+w*u*b,this.z=h*u*b+w*d*f,this.w=h*u*f-w*d*b):c==="ZYX"?(this.x=w*u*f-h*d*b,this.y=h*d*f+w*u*b,this.z=h*u*b-w*d*f,this.w=h*u*f+w*d*b):c==="YZX"?(this.x=w*u*f+h*d*b,this.y=h*d*f+w*u*b,this.z=h*u*b-w*d*f,this.w=h*u*f-w*d*b):c==="XZY"&&(this.x=w*u*f-h*d*b,this.y=h*d*f-w*u*b,this.z=h*u*b+w*d*f,this.w=h*u*f+w*d*b),this},e.prototype.clone=function(){return new e(this.x,this.y,this.z,this.w)}},{"./Vec3":30}],29:[function(v,I,ht){var p=v("./Vec3"),e=v("./Quaternion");I.exports=n;function n(l){l=l||{},this.position=new p,l.position&&this.position.copy(l.position),this.quaternion=new e,l.quaternion&&this.quaternion.copy(l.quaternion)}var r=new e;n.pointToLocalFrame=function(l,o,t,i){var i=i||new p;return t.vsub(l,i),o.conjugate(r),r.vmult(i,i),i},n.prototype.pointToLocal=function(l,o){return n.pointToLocalFrame(this.position,this.quaternion,l,o)},n.pointToWorldFrame=function(l,o,t,i){var i=i||new p;return o.vmult(t,i),i.vadd(l,i),i},n.prototype.pointToWorld=function(l,o){return n.pointToWorldFrame(this.position,this.quaternion,l,o)},n.prototype.vectorToWorldFrame=function(l,o){var o=o||new p;return this.quaternion.vmult(l,o),o},n.vectorToWorldFrame=function(l,o,t){return l.vmult(o,t),t},n.vectorToLocalFrame=function(l,o,t,i){var i=i||new p;return o.w*=-1,o.vmult(t,i),o.w*=-1,i}},{"./Quaternion":28,"./Vec3":30}],30:[function(v,I,ht){I.exports=e;var p=v("./Mat3");function e(o,t,i){this.x=o||0,this.y=t||0,this.z=i||0}e.ZERO=new e(0,0,0),e.UNIT_X=new e(1,0,0),e.UNIT_Y=new e(0,1,0),e.UNIT_Z=new e(0,0,1),e.prototype.cross=function(o,t){var i=o.x,s=o.y,a=o.z,c=this.x,h=this.y,u=this.z;return t=t||new e,t.x=h*a-u*s,t.y=u*i-c*a,t.z=c*s-h*i,t},e.prototype.set=function(o,t,i){return this.x=o,this.y=t,this.z=i,this},e.prototype.setZero=function(){this.x=this.y=this.z=0},e.prototype.vadd=function(o,t){if(t)t.x=o.x+this.x,t.y=o.y+this.y,t.z=o.z+this.z;else return new e(this.x+o.x,this.y+o.y,this.z+o.z)},e.prototype.vsub=function(o,t){if(t)t.x=this.x-o.x,t.y=this.y-o.y,t.z=this.z-o.z;else return new e(this.x-o.x,this.y-o.y,this.z-o.z)},e.prototype.crossmat=function(){return new p([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])},e.prototype.normalize=function(){var o=this.x,t=this.y,i=this.z,s=Math.sqrt(o*o+t*t+i*i);if(s>0){var a=1/s;this.x*=a,this.y*=a,this.z*=a}else this.x=0,this.y=0,this.z=0;return s},e.prototype.unit=function(o){o=o||new e;var t=this.x,i=this.y,s=this.z,a=Math.sqrt(t*t+i*i+s*s);return a>0?(a=1/a,o.x=t*a,o.y=i*a,o.z=s*a):(o.x=1,o.y=0,o.z=0),o},e.prototype.norm=function(){var o=this.x,t=this.y,i=this.z;return Math.sqrt(o*o+t*t+i*i)},e.prototype.length=e.prototype.norm,e.prototype.norm2=function(){return this.dot(this)},e.prototype.lengthSquared=e.prototype.norm2,e.prototype.distanceTo=function(o){var t=this.x,i=this.y,s=this.z,a=o.x,c=o.y,h=o.z;return Math.sqrt((a-t)*(a-t)+(c-i)*(c-i)+(h-s)*(h-s))},e.prototype.distanceSquared=function(o){var t=this.x,i=this.y,s=this.z,a=o.x,c=o.y,h=o.z;return(a-t)*(a-t)+(c-i)*(c-i)+(h-s)*(h-s)},e.prototype.mult=function(o,t){t=t||new e;var i=this.x,s=this.y,a=this.z;return t.x=o*i,t.y=o*s,t.z=o*a,t},e.prototype.scale=e.prototype.mult,e.prototype.dot=function(o){return this.x*o.x+this.y*o.y+this.z*o.z},e.prototype.isZero=function(){return this.x===0&&this.y===0&&this.z===0},e.prototype.negate=function(o){return o=o||new e,o.x=-this.x,o.y=-this.y,o.z=-this.z,o};var n=new e,r=new e;e.prototype.tangents=function(o,t){var i=this.norm();if(i>0){var s=n,a=1/i;s.set(this.x*a,this.y*a,this.z*a);var c=r;Math.abs(s.x)<.9?(c.set(1,0,0),s.cross(c,o)):(c.set(0,1,0),s.cross(c,o)),s.cross(o,t)}else o.set(1,0,0),t.set(0,1,0)},e.prototype.toString=function(){return this.x+","+this.y+","+this.z},e.prototype.toArray=function(){return[this.x,this.y,this.z]},e.prototype.copy=function(o){return this.x=o.x,this.y=o.y,this.z=o.z,this},e.prototype.lerp=function(o,t,i){var s=this.x,a=this.y,c=this.z;i.x=s+(o.x-s)*t,i.y=a+(o.y-a)*t,i.z=c+(o.z-c)*t},e.prototype.almostEquals=function(o,t){return t===void 0&&(t=1e-6),!(Math.abs(this.x-o.x)>t||Math.abs(this.y-o.y)>t||Math.abs(this.z-o.z)>t)},e.prototype.almostZero=function(o){return o===void 0&&(o=1e-6),!(Math.abs(this.x)>o||Math.abs(this.y)>o||Math.abs(this.z)>o)};var l=new e;e.prototype.isAntiparallelTo=function(o,t){return this.negate(l),l.almostEquals(o,t)},e.prototype.clone=function(){return new e(this.x,this.y,this.z)}},{"./Mat3":27}],31:[function(v,I,ht){I.exports=t;var p=v("../utils/EventTarget");v("../shapes/Shape");var e=v("../math/Vec3"),n=v("../math/Mat3"),r=v("../math/Quaternion");v("../material/Material");var l=v("../collision/AABB"),o=v("../shapes/Box");function t(B){B=B||{},p.apply(this),this.id=t.idCounter++,this.world=null,this.preStep=null,this.postStep=null,this.vlambda=new e,this.collisionFilterGroup=typeof B.collisionFilterGroup=="number"?B.collisionFilterGroup:1,this.collisionFilterMask=typeof B.collisionFilterMask=="number"?B.collisionFilterMask:1,this.collisionResponse=!0,this.position=new e,B.position&&this.position.copy(B.position),this.previousPosition=new e,this.initPosition=new e,this.velocity=new e,B.velocity&&this.velocity.copy(B.velocity),this.initVelocity=new e,this.force=new e;var R=typeof B.mass=="number"?B.mass:0;this.mass=R,this.invMass=R>0?1/R:0,this.material=B.material||null,this.linearDamping=typeof B.linearDamping=="number"?B.linearDamping:.01,this.type=R<=0?t.STATIC:t.DYNAMIC,typeof B.type==typeof t.STATIC&&(this.type=B.type),this.allowSleep=typeof B.allowSleep!="undefined"?B.allowSleep:!0,this.sleepState=0,this.sleepSpeedLimit=typeof B.sleepSpeedLimit!="undefined"?B.sleepSpeedLimit:.1,this.sleepTimeLimit=typeof B.sleepTimeLimit!="undefined"?B.sleepTimeLimit:1,this.timeLastSleepy=0,this._wakeUpAfterNarrowphase=!1,this.torque=new e,this.quaternion=new r,B.quaternion&&this.quaternion.copy(B.quaternion),this.initQuaternion=new r,this.angularVelocity=new e,B.angularVelocity&&this.angularVelocity.copy(B.angularVelocity),this.initAngularVelocity=new e,this.interpolatedPosition=new e,this.interpolatedQuaternion=new r,this.shapes=[],this.shapeOffsets=[],this.shapeOrientations=[],this.inertia=new e,this.invInertia=new e,this.invInertiaWorld=new n,this.invMassSolve=0,this.invInertiaSolve=new e,this.invInertiaWorldSolve=new n,this.fixedRotation=typeof B.fixedRotation!="undefined"?B.fixedRotation:!1,this.angularDamping=typeof B.angularDamping!="undefined"?B.angularDamping:.01,this.aabb=new l,this.aabbNeedsUpdate=!0,this.wlambda=new e,B.shape&&this.addShape(B.shape),this.updateMassProperties()}t.prototype=new p,t.prototype.constructor=t,t.DYNAMIC=1,t.STATIC=2,t.KINEMATIC=4,t.AWAKE=0,t.SLEEPY=1,t.SLEEPING=2,t.idCounter=0,t.prototype.wakeUp=function(){var B=this.sleepState;this.sleepState=0,B===t.SLEEPING&&this.dispatchEvent({type:"wakeup"})},t.prototype.sleep=function(){this.sleepState=t.SLEEPING,this.velocity.set(0,0,0),this.angularVelocity.set(0,0,0)},t.sleepyEvent={type:"sleepy"},t.sleepEvent={type:"sleep"},t.prototype.sleepTick=function(B){if(this.allowSleep){var R=this.sleepState,D=this.velocity.norm2()+this.angularVelocity.norm2(),$=Math.pow(this.sleepSpeedLimit,2);R===t.AWAKE&&D<$?(this.sleepState=t.SLEEPY,this.timeLastSleepy=B,this.dispatchEvent(t.sleepyEvent)):R===t.SLEEPY&&D>$?this.wakeUp():R===t.SLEEPY&&B-this.timeLastSleepy>this.sleepTimeLimit&&(this.sleep(),this.dispatchEvent(t.sleepEvent))}},t.prototype.updateSolveMassProperties=function(){this.sleepState===t.SLEEPING||this.type===t.KINEMATIC?(this.invMassSolve=0,this.invInertiaSolve.setZero(),this.invInertiaWorldSolve.setZero()):(this.invMassSolve=this.invMass,this.invInertiaSolve.copy(this.invInertia),this.invInertiaWorldSolve.copy(this.invInertiaWorld))},t.prototype.pointToLocalFrame=function(B,R){var R=R||new e;return B.vsub(this.position,R),this.quaternion.conjugate().vmult(R,R),R},t.prototype.vectorToLocalFrame=function(B,R){var R=R||new e;return this.quaternion.conjugate().vmult(B,R),R},t.prototype.pointToWorldFrame=function(B,R){var R=R||new e;return this.quaternion.vmult(B,R),R.vadd(this.position,R),R},t.prototype.vectorToWorldFrame=function(B,R){var R=R||new e;return this.quaternion.vmult(B,R),R};var i=new e,s=new r;t.prototype.addShape=function(B,R,D){var $=new e,K=new r;return R&&$.copy(R),D&&K.copy(D),this.shapes.push(B),this.shapeOffsets.push($),this.shapeOrientations.push(K),this.updateMassProperties(),this.updateBoundingRadius(),this.aabbNeedsUpdate=!0,this},t.prototype.updateBoundingRadius=function(){for(var B=this.shapes,R=this.shapeOffsets,D=B.length,$=0,K=0;K!==D;K++){var ut=B[K];ut.updateBoundingSphereRadius();var M=R[K].norm(),E=ut.boundingSphereRadius;M+E>$&&($=M+E)}this.boundingRadius=$};var a=new l;t.prototype.computeAABB=function(){for(var B=this.shapes,R=this.shapeOffsets,D=this.shapeOrientations,$=B.length,K=i,ut=s,M=this.quaternion,E=this.aabb,_=a,L=0;L!==$;L++){var g=B[L];D[L].mult(M,ut),ut.vmult(R[L],K),K.vadd(this.position,K),g.calculateWorldAABB(K,ut,_.lowerBound,_.upperBound),L===0?E.copy(_):E.extend(_)}this.aabbNeedsUpdate=!1};var c=new n,h=new n;new n,t.prototype.updateInertiaWorld=function(B){var R=this.invInertia;if(!(R.x===R.y&&R.y===R.z&&!B)){var D=c,$=h;D.setRotationFromQuaternion(this.quaternion),D.transpose($),D.scale(R,D),D.mmult($,this.invInertiaWorld)}};var u=new e,f=new e;t.prototype.applyForce=function(B,R){if(this.type===t.DYNAMIC){var D=u;R.vsub(this.position,D);var $=f;D.cross(B,$),this.force.vadd(B,this.force),this.torque.vadd($,this.torque)}};var w=new e,d=new e;t.prototype.applyLocalForce=function(B,R){if(this.type===t.DYNAMIC){var D=w,$=d;this.vectorToWorldFrame(B,D),this.pointToWorldFrame(R,$),this.applyForce(D,$)}};var b=new e,k=new e,at=new e;t.prototype.applyImpulse=function(B,R){if(this.type===t.DYNAMIC){var D=b;R.vsub(this.position,D);var $=k;$.copy(B),$.mult(this.invMass,$),this.velocity.vadd($,this.velocity);var K=at;D.cross(B,K),this.invInertiaWorld.vmult(K,K),this.angularVelocity.vadd(K,this.angularVelocity)}};var T=new e,H=new e;t.prototype.applyLocalImpulse=function(B,R){if(this.type===t.DYNAMIC){var D=T,$=H;this.vectorToWorldFrame(B,D),this.pointToWorldFrame(R,$),this.applyImpulse(D,$)}};var z=new e;t.prototype.updateMassProperties=function(){var B=z;this.invMass=this.mass>0?1/this.mass:0;var R=this.inertia,D=this.fixedRotation;this.computeAABB(),B.set((this.aabb.upperBound.x-this.aabb.lowerBound.x)/2,(this.aabb.upperBound.y-this.aabb.lowerBound.y)/2,(this.aabb.upperBound.z-this.aabb.lowerBound.z)/2),o.calculateInertia(B,this.mass,R),this.invInertia.set(R.x>0&&!D?1/R.x:0,R.y>0&&!D?1/R.y:0,R.z>0&&!D?1/R.z:0),this.updateInertiaWorld(!0)},t.prototype.getVelocityAtWorldPoint=function(B,R){var D=new e;return B.vsub(this.position,D),this.angularVelocity.cross(D,R),this.velocity.vadd(R,R),R}},{"../collision/AABB":3,"../material/Material":25,"../math/Mat3":27,"../math/Quaternion":28,"../math/Vec3":30,"../shapes/Box":37,"../shapes/Shape":43,"../utils/EventTarget":49}],32:[function(v,I,ht){v("./Body");var p=v("../math/Vec3"),e=v("../math/Quaternion");v("../collision/RaycastResult");var n=v("../collision/Ray"),r=v("../objects/WheelInfo");I.exports=l;function l(M){this.chassisBody=M.chassisBody,this.wheelInfos=[],this.sliding=!1,this.world=null,this.indexRightAxis=typeof M.indexRightAxis!="undefined"?M.indexRightAxis:1,this.indexForwardAxis=typeof M.indexForwardAxis!="undefined"?M.indexForwardAxis:0,this.indexUpAxis=typeof M.indexUpAxis!="undefined"?M.indexUpAxis:2}new p,new p,new p;var o=new p,t=new p,i=new p;new n,l.prototype.addWheel=function(M){M=M||{};var E=new r(M),_=this.wheelInfos.length;return this.wheelInfos.push(E),_},l.prototype.setSteeringValue=function(M,E){var _=this.wheelInfos[E];_.steering=M},new p,l.prototype.applyEngineForce=function(M,E){this.wheelInfos[E].engineForce=M},l.prototype.setBrake=function(M,E){this.wheelInfos[E].brake=M},l.prototype.addToWorld=function(M){this.constraints,M.add(this.chassisBody);var E=this;this.preStepCallback=function(){E.updateVehicle(M.dt)},M.addEventListener("preStep",this.preStepCallback),this.world=M},l.prototype.getVehicleAxisWorld=function(M,E){E.set(M===0?1:0,M===1?1:0,M===2?1:0),this.chassisBody.vectorToWorldFrame(E,E)},l.prototype.updateVehicle=function(M){for(var E=this.wheelInfos,_=E.length,L=this.chassisBody,g=0;g<_;g++)this.updateWheelTransform(g);this.currentVehicleSpeedKmHour=3.6*L.velocity.norm();var P=new p;this.getVehicleAxisWorld(this.indexForwardAxis,P),P.dot(L.velocity)<0&&(this.currentVehicleSpeedKmHour*=-1);for(var g=0;g<_;g++)this.castRay(E[g]);this.updateSuspension(M);for(var x=new p,m=new p,g=0;g<_;g++){var y=E[g],A=y.suspensionForce;A>y.maxSuspensionForce&&(A=y.maxSuspensionForce),y.raycastResult.hitNormalWorld.scale(A*M,x),y.raycastResult.hitPointWorld.vsub(L.position,m),L.applyImpulse(x,y.raycastResult.hitPointWorld)}this.updateFriction(M);var O=new p,N=new p,C=new p;for(g=0;g<_;g++){var y=E[g];L.getVelocityAtWorldPoint(y.chassisConnectionPointWorld,C);var W=1;switch(this.indexUpAxis){case 1:W=-1;break}if(y.isInContact){this.getVehicleAxisWorld(this.indexForwardAxis,N);var X=N.dot(y.raycastResult.hitNormalWorld);y.raycastResult.hitNormalWorld.scale(X,O),N.vsub(O,N);var ct=N.dot(C);y.deltaRotation=W*ct*M/y.radius}(y.sliding||!y.isInContact)&&y.engineForce!==0&&y.useCustomSlidingRotationalSpeed&&(y.deltaRotation=(y.engineForce>0?1:-1)*y.customSlidingRotationalSpeed*M),Math.abs(y.brake)>Math.abs(y.engineForce)&&(y.deltaRotation=0),y.rotation+=y.deltaRotation,y.deltaRotation*=.99}},l.prototype.updateSuspension=function(M){for(var E=this.chassisBody,_=E.mass,L=this.wheelInfos,g=L.length,P=0;P<g;P++){var x=L[P];if(x.isInContact){var m,y=x.suspensionRestLength,A=x.suspensionLength,O=y-A;m=x.suspensionStiffness*O*x.clippedInvContactDotSuspension;var N=x.suspensionRelativeVelocity,C;N<0?C=x.dampingCompression:C=x.dampingRelaxation,m-=C*N,x.suspensionForce=m*_,x.suspensionForce<0&&(x.suspensionForce=0)}else x.suspensionForce=0}},l.prototype.removeFromWorld=function(M){this.constraints,M.remove(this.chassisBody),M.removeEventListener("preStep",this.preStepCallback),this.world=null};var s=new p,a=new p;l.prototype.castRay=function(M){var E=s,_=a;this.updateWheelTransformWorld(M);var L=this.chassisBody,g=-1,P=M.suspensionRestLength+M.radius;M.directionWorld.scale(P,E);var x=M.chassisConnectionPointWorld;x.vadd(E,_);var m=M.raycastResult;m.reset();var y=L.collisionResponse;L.collisionResponse=!1,this.world.rayTest(x,_,m),L.collisionResponse=y;var A=m.body;if(M.raycastResult.groundObject=0,A){g=m.distance,M.raycastResult.hitNormalWorld=m.hitNormalWorld,M.isInContact=!0;var O=m.distance;M.suspensionLength=O-M.radius;var N=M.suspensionRestLength-M.maxSuspensionTravel,C=M.suspensionRestLength+M.maxSuspensionTravel;M.suspensionLength<N&&(M.suspensionLength=N),M.suspensionLength>C&&(M.suspensionLength=C,M.raycastResult.reset());var W=M.raycastResult.hitNormalWorld.dot(M.directionWorld),X=new p;L.getVelocityAtWorldPoint(M.raycastResult.hitPointWorld,X);var ct=M.raycastResult.hitNormalWorld.dot(X);if(W>=-.1)M.suspensionRelativeVelocity=0,M.clippedInvContactDotSuspension=1/.1;else{var st=-1/W;M.suspensionRelativeVelocity=ct*st,M.clippedInvContactDotSuspension=st}}else M.suspensionLength=M.suspensionRestLength+0*M.maxSuspensionTravel,M.suspensionRelativeVelocity=0,M.directionWorld.scale(-1,M.raycastResult.hitNormalWorld),M.clippedInvContactDotSuspension=1;return g},l.prototype.updateWheelTransformWorld=function(M){M.isInContact=!1;var E=this.chassisBody;E.pointToWorldFrame(M.chassisConnectionPointLocal,M.chassisConnectionPointWorld),E.vectorToWorldFrame(M.directionLocal,M.directionWorld),E.vectorToWorldFrame(M.axleLocal,M.axleWorld)},l.prototype.updateWheelTransform=function(M){var E=o,_=t,L=i,g=this.wheelInfos[M];this.updateWheelTransformWorld(g),g.directionLocal.scale(-1,E),_.copy(g.axleLocal),E.cross(_,L),L.normalize(),_.normalize();var P=g.steering,x=new e;x.setFromAxisAngle(E,P);var m=new e;m.setFromAxisAngle(_,g.rotation);var y=g.worldTransform.quaternion;this.chassisBody.quaternion.mult(x,y),y.mult(m,y),y.normalize();var A=g.worldTransform.position;A.copy(g.directionWorld),A.scale(g.suspensionLength,A),A.vadd(g.chassisConnectionPointWorld,A)};var c=[new p(1,0,0),new p(0,1,0),new p(0,0,1)];l.prototype.getWheelTransformWorld=function(M){return this.wheelInfos[M].worldTransform};var h=new p,u=[],f=[],w=1;l.prototype.updateFriction=function(M){for(var E=h,_=this.wheelInfos,L=_.length,g=this.chassisBody,P=f,x=u,m=0;m<L;m++){var y=_[m],A=y.raycastResult.body;y.sideImpulse=0,y.forwardImpulse=0,P[m]||(P[m]=new p),x[m]||(x[m]=new p)}for(var m=0;m<L;m++){var y=_[m],A=y.raycastResult.body;if(A){var O=x[m],N=this.getWheelTransformWorld(m);N.vectorToWorldFrame(c[this.indexRightAxis],O);var C=y.raycastResult.hitNormalWorld,W=O.dot(C);C.scale(W,E),O.vsub(E,O),O.normalize(),C.cross(O,P[m]),P[m].normalize(),y.sideImpulse=ut(g,y.raycastResult.hitPointWorld,A,y.raycastResult.hitPointWorld,O),y.sideImpulse*=w}}var X=1,ct=.5;this.sliding=!1;for(var m=0;m<L;m++){var y=_[m],A=y.raycastResult.body,st=0;if(y.slipInfo=1,A){var nt=0,q=y.brake?y.brake:nt;st=at(g,A,y.raycastResult.hitPointWorld,P[m],q),st+=y.engineForce*M;var Q=q/st;y.slipInfo*=Q}if(y.forwardImpulse=0,y.skidInfo=1,A){y.skidInfo=1;var Ct=y.suspensionForce*M*y.frictionSlip,dt=Ct,Mt=Ct*dt;y.forwardImpulse=st;var vt=y.forwardImpulse*ct,At=y.sideImpulse*X,gt=vt*vt+At*At;if(y.sliding=!1,gt>Mt){this.sliding=!0,y.sliding=!0;var Q=Ct/Math.sqrt(gt);y.skidInfo*=Q}}}if(this.sliding)for(var m=0;m<L;m++){var y=_[m];y.sideImpulse!==0&&y.skidInfo<1&&(y.forwardImpulse*=y.skidInfo,y.sideImpulse*=y.skidInfo)}for(var m=0;m<L;m++){var y=_[m],zt=new p;if(zt.copy(y.raycastResult.hitPointWorld),y.forwardImpulse!==0){var Vt=new p;P[m].scale(y.forwardImpulse,Vt),g.applyImpulse(Vt,zt)}if(y.sideImpulse!==0){var A=y.raycastResult.body,St=new p;St.copy(y.raycastResult.hitPointWorld);var Nt=new p;x[m].scale(y.sideImpulse,Nt),g.pointToLocalFrame(zt,zt),zt["xyz"[this.indexUpAxis]]*=y.rollInfluence,g.pointToWorldFrame(zt,zt),g.applyImpulse(Nt,zt),Nt.scale(-1,Nt),A.applyImpulse(Nt,St)}}};var d=new p,b=new p,k=new p;function at(M,E,_,L,g){var P=0,x=_,m=d,y=b,A=k;M.getVelocityAtWorldPoint(x,m),E.getVelocityAtWorldPoint(x,y),m.vsub(y,A);var O=L.dot(A),N=R(M,_,L),C=R(E,_,L),W=1,X=W/(N+C);return P=-O*X,g<P&&(P=g),P<-g&&(P=-g),P}var T=new p,H=new p,z=new p,B=new p;function R(M,E,_){var L=T,g=H,P=z,x=B;return E.vsub(M.position,L),L.cross(_,g),M.invInertiaWorld.vmult(g,x),x.cross(L,P),M.invMass+_.dot(P)}var D=new p,$=new p,K=new p;function ut(M,E,_,L,g,P){var x=g.norm2();if(x>1.1)return 0;var m=D,y=$,A=K;M.getVelocityAtWorldPoint(E,m),_.getVelocityAtWorldPoint(L,y),m.vsub(y,A);var O=g.dot(A),N=.2,C=1/(M.invMass+_.invMass),P=-N*O*C;return P}},{"../collision/Ray":9,"../collision/RaycastResult":10,"../math/Quaternion":28,"../math/Vec3":30,"../objects/WheelInfo":36,"./Body":31}],33:[function(v,I,ht){var p=v("./Body"),e=v("../shapes/Sphere"),n=v("../shapes/Box"),r=v("../math/Vec3"),l=v("../constraints/HingeConstraint");I.exports=o;function o(s){if(this.wheelBodies=[],this.coordinateSystem=typeof s.coordinateSystem=="undefined"?new r(1,2,3):s.coordinateSystem.clone(),this.chassisBody=s.chassisBody,!this.chassisBody){var a=new n(new r(5,2,.5));this.chassisBody=new p(1,a)}this.constraints=[],this.wheelAxes=[],this.wheelForces=[]}o.prototype.addWheel=function(s){s=s||{};var a=s.body;a||(a=new p(1,new e(1.2))),this.wheelBodies.push(a),this.wheelForces.push(0),new r;var c=typeof s.position!="undefined"?s.position.clone():new r,h=new r;this.chassisBody.pointToWorldFrame(c,h),a.position.set(h.x,h.y,h.z);var u=typeof s.axis!="undefined"?s.axis.clone():new r(0,1,0);this.wheelAxes.push(u);var f=new l(this.chassisBody,a,{pivotA:c,axisA:u,pivotB:r.ZERO,axisB:u,collideConnected:!1});return this.constraints.push(f),this.wheelBodies.length-1},o.prototype.setSteeringValue=function(s,a){var c=this.wheelAxes[a],h=Math.cos(s),u=Math.sin(s),f=c.x,w=c.y;this.constraints[a].axisA.set(h*f-u*w,u*f+h*w,0)},o.prototype.setMotorSpeed=function(s,a){var c=this.constraints[a];c.enableMotor(),c.motorTargetVelocity=s},o.prototype.disableMotor=function(s){var a=this.constraints[s];a.disableMotor()};var t=new r;o.prototype.setWheelForce=function(s,a){this.wheelForces[a]=s},o.prototype.applyWheelForce=function(s,a){var c=this.wheelAxes[a],h=this.wheelBodies[a],u=h.torque;c.scale(s,t),h.vectorToWorldFrame(t,t),u.vadd(t,u)},o.prototype.addToWorld=function(s){for(var a=this.constraints,c=this.wheelBodies.concat([this.chassisBody]),h=0;h<c.length;h++)s.add(c[h]);for(var h=0;h<a.length;h++)s.addConstraint(a[h]);s.addEventListener("preStep",this._update.bind(this))},o.prototype._update=function(){for(var s=this.wheelForces,a=0;a<s.length;a++)this.applyWheelForce(s[a],a)},o.prototype.removeFromWorld=function(s){for(var a=this.constraints,c=this.wheelBodies.concat([this.chassisBody]),h=0;h<c.length;h++)s.remove(c[h]);for(var h=0;h<a.length;h++)s.removeConstraint(a[h])};var i=new r;o.prototype.getWheelSpeed=function(s){var a=this.wheelAxes[s],c=this.wheelBodies[s],h=c.angularVelocity;return this.chassisBody.vectorToWorldFrame(a,i),h.dot(i)}},{"../constraints/HingeConstraint":15,"../math/Vec3":30,"../shapes/Box":37,"../shapes/Sphere":44,"./Body":31}],34:[function(v,I,ht){I.exports=e,v("../shapes/Shape");var p=v("../math/Vec3");v("../math/Quaternion"),v("../shapes/Particle"),v("../objects/Body"),v("../material/Material");function e(){this.particles=[],this.density=1,this.smoothingRadius=1,this.speedOfSound=1,this.viscosity=.01,this.eps=1e-6,this.pressures=[],this.densities=[],this.neighbors=[]}e.prototype.add=function(a){this.particles.push(a),this.neighbors.length<this.particles.length&&this.neighbors.push([])},e.prototype.remove=function(a){var c=this.particles.indexOf(a);c!==-1&&(this.particles.splice(c,1),this.neighbors.length>this.particles.length&&this.neighbors.pop())};var n=new p;e.prototype.getNeighbors=function(a,c){for(var h=this.particles.length,u=a.id,f=this.smoothingRadius*this.smoothingRadius,w=n,d=0;d!==h;d++){var b=this.particles[d];b.position.vsub(a.position,w),u!==b.id&&w.norm2()<f&&c.push(b)}};var r=new p,l=new p,o=new p,t=new p,i=new p,s=new p;e.prototype.update=function(){for(var a=this.particles.length,c=r,h=this.speedOfSound,u=this.eps,f=0;f!==a;f++){var w=this.particles[f],d=this.neighbors[f];d.length=0,this.getNeighbors(w,d),d.push(this.particles[f]);for(var b=d.length,k=0,at=0;at!==b;at++){w.position.vsub(d[at].position,c);var T=c.norm(),H=this.w(T);k+=d[at].mass*H}this.densities[f]=k,this.pressures[f]=h*h*(this.densities[f]-this.density)}for(var z=l,B=o,R=t,D=i,$=s,f=0;f!==a;f++){var K=this.particles[f];z.set(0,0,0),B.set(0,0,0);for(var ut,M,d=this.neighbors[f],b=d.length,at=0;at!==b;at++){var E=d[at];K.position.vsub(E.position,D);var _=D.norm();ut=-E.mass*(this.pressures[f]/(this.densities[f]*this.densities[f]+u)+this.pressures[at]/(this.densities[at]*this.densities[at]+u)),this.gradw(D,R),R.mult(ut,R),z.vadd(R,z),E.velocity.vsub(K.velocity,$),$.mult(1/(1e-4+this.densities[f]*this.densities[at])*this.viscosity*E.mass,$),M=this.nablaw(_),$.mult(M,$),B.vadd($,B)}B.mult(K.mass,B),z.mult(K.mass,z),K.force.vadd(B,K.force),K.force.vadd(z,K.force)}},e.prototype.w=function(a){var c=this.smoothingRadius;return 315/(64*Math.PI*Math.pow(c,9))*Math.pow(c*c-a*a,3)},e.prototype.gradw=function(a,c){var h=a.norm(),u=this.smoothingRadius;a.mult(945/(32*Math.PI*Math.pow(u,9))*Math.pow(u*u-h*h,2),c)},e.prototype.nablaw=function(a){var c=this.smoothingRadius,h=945/(32*Math.PI*Math.pow(c,9))*(c*c-a*a)*(7*a*a-3*c*c);return h}},{"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Particle":41,"../shapes/Shape":43}],35:[function(v,I,ht){var p=v("../math/Vec3");I.exports=e;function e(f,w,d){d=d||{},this.restLength=typeof d.restLength=="number"?d.restLength:1,this.stiffness=d.stiffness||100,this.damping=d.damping||1,this.bodyA=f,this.bodyB=w,this.localAnchorA=new p,this.localAnchorB=new p,d.localAnchorA&&this.localAnchorA.copy(d.localAnchorA),d.localAnchorB&&this.localAnchorB.copy(d.localAnchorB),d.worldAnchorA&&this.setWorldAnchorA(d.worldAnchorA),d.worldAnchorB&&this.setWorldAnchorB(d.worldAnchorB)}e.prototype.setWorldAnchorA=function(f){this.bodyA.pointToLocalFrame(f,this.localAnchorA)},e.prototype.setWorldAnchorB=function(f){this.bodyB.pointToLocalFrame(f,this.localAnchorB)},e.prototype.getWorldAnchorA=function(f){this.bodyA.pointToWorldFrame(this.localAnchorA,f)},e.prototype.getWorldAnchorB=function(f){this.bodyB.pointToWorldFrame(this.localAnchorB,f)};var n=new p,r=new p,l=new p,o=new p,t=new p,i=new p,s=new p,a=new p,c=new p,h=new p,u=new p;e.prototype.applyForce=function(){var f=this.stiffness,w=this.damping,d=this.restLength,b=this.bodyA,k=this.bodyB,at=n,T=r,H=l,z=o,B=u,R=t,D=i,$=s,K=a,ut=c,M=h;this.getWorldAnchorA(R),this.getWorldAnchorB(D),R.vsub(b.position,$),D.vsub(k.position,K),D.vsub(R,at);var E=at.norm();T.copy(at),T.normalize(),k.velocity.vsub(b.velocity,H),k.angularVelocity.cross(K,B),H.vadd(B,H),b.angularVelocity.cross($,B),H.vsub(B,H),T.mult(-f*(E-d)-w*H.dot(T),z),b.force.vsub(z,b.force),k.force.vadd(z,k.force),$.cross(z,ut),K.cross(z,M),b.torque.vsub(ut,b.torque),k.torque.vadd(M,k.torque)}},{"../math/Vec3":30}],36:[function(v,I,ht){var p=v("../math/Vec3"),e=v("../math/Transform"),n=v("../collision/RaycastResult"),r=v("../utils/Utils");I.exports=l;function l(i){i=r.defaults(i,{chassisConnectionPointLocal:new p,chassisConnectionPointWorld:new p,directionLocal:new p,directionWorld:new p,axleLocal:new p,axleWorld:new p,suspensionRestLength:1,suspensionMaxLength:2,radius:1,suspensionStiffness:100,dampingCompression:10,dampingRelaxation:10,frictionSlip:1e4,steering:0,rotation:0,deltaRotation:0,rollInfluence:.01,maxSuspensionForce:Number.MAX_VALUE,isFrontWheel:!0,clippedInvContactDotSuspension:1,suspensionRelativeVelocity:0,suspensionForce:0,skidInfo:0,suspensionLength:0,maxSuspensionTravel:1,useCustomSlidingRotationalSpeed:!1,customSlidingRotationalSpeed:-.1}),this.maxSuspensionTravel=i.maxSuspensionTravel,this.customSlidingRotationalSpeed=i.customSlidingRotationalSpeed,this.useCustomSlidingRotationalSpeed=i.useCustomSlidingRotationalSpeed,this.sliding=!1,this.chassisConnectionPointLocal=i.chassisConnectionPointLocal.clone(),this.chassisConnectionPointWorld=i.chassisConnectionPointWorld.clone(),this.directionLocal=i.directionLocal.clone(),this.directionWorld=i.directionWorld.clone(),this.axleLocal=i.axleLocal.clone(),this.axleWorld=i.axleWorld.clone(),this.suspensionRestLength=i.suspensionRestLength,this.suspensionMaxLength=i.suspensionMaxLength,this.radius=i.radius,this.suspensionStiffness=i.suspensionStiffness,this.dampingCompression=i.dampingCompression,this.dampingRelaxation=i.dampingRelaxation,this.frictionSlip=i.frictionSlip,this.steering=0,this.rotation=0,this.deltaRotation=0,this.rollInfluence=i.rollInfluence,this.maxSuspensionForce=i.maxSuspensionForce,this.engineForce=0,this.brake=0,this.isFrontWheel=i.isFrontWheel,this.clippedInvContactDotSuspension=1,this.suspensionRelativeVelocity=0,this.suspensionForce=0,this.skidInfo=0,this.suspensionLength=0,this.sideImpulse=0,this.forwardImpulse=0,this.raycastResult=new n,this.worldTransform=new e,this.isInContact=!1}var o=new p,t=new p,o=new p;l.prototype.updateWheel=function(i){var s=this.raycastResult;if(this.isInContact){var a=s.hitNormalWorld.dot(s.directionWorld);s.hitPointWorld.vsub(i.position,t),i.getVelocityAtWorldPoint(t,o);var c=s.hitNormalWorld.dot(o);if(a>=-.1)this.suspensionRelativeVelocity=0,this.clippedInvContactDotSuspension=1/.1;else{var h=-1/a;this.suspensionRelativeVelocity=c*h,this.clippedInvContactDotSuspension=h}}else s.suspensionLength=this.suspensionRestLength,this.suspensionRelativeVelocity=0,s.directionWorld.scale(-1,s.hitNormalWorld),this.clippedInvContactDotSuspension=1}},{"../collision/RaycastResult":10,"../math/Transform":29,"../math/Vec3":30,"../utils/Utils":53}],37:[function(v,I,ht){I.exports=r;var p=v("./Shape"),e=v("../math/Vec3"),n=v("./ConvexPolyhedron");function r(t){p.call(this),this.type=p.types.BOX,this.halfExtents=t,this.convexPolyhedronRepresentation=null,this.updateConvexPolyhedronRepresentation(),this.updateBoundingSphereRadius()}r.prototype=new p,r.prototype.constructor=r,r.prototype.updateConvexPolyhedronRepresentation=function(){var t=this.halfExtents.x,i=this.halfExtents.y,s=this.halfExtents.z,a=e,c=[new a(-t,-i,-s),new a(t,-i,-s),new a(t,i,-s),new a(-t,i,-s),new a(-t,-i,s),new a(t,-i,s),new a(t,i,s),new a(-t,i,s)],h=[[3,2,1,0],[4,5,6,7],[5,4,0,1],[2,3,7,6],[0,4,7,3],[1,2,6,5]];new a(0,0,1),new a(0,1,0),new a(1,0,0);var u=new n(c,h);this.convexPolyhedronRepresentation=u,u.material=this.material},r.prototype.calculateLocalInertia=function(t,i){return i=i||new e,r.calculateInertia(this.halfExtents,t,i),i},r.calculateInertia=function(t,i,s){var a=t;s.x=1/12*i*(2*a.y*2*a.y+2*a.z*2*a.z),s.y=1/12*i*(2*a.x*2*a.x+2*a.z*2*a.z),s.z=1/12*i*(2*a.y*2*a.y+2*a.x*2*a.x)},r.prototype.getSideNormals=function(t,i){var s=t,a=this.halfExtents;if(s[0].set(a.x,0,0),s[1].set(0,a.y,0),s[2].set(0,0,a.z),s[3].set(-a.x,0,0),s[4].set(0,-a.y,0),s[5].set(0,0,-a.z),i!==void 0)for(var c=0;c!==s.length;c++)i.vmult(s[c],s[c]);return s},r.prototype.volume=function(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z},r.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.halfExtents.norm()};var l=new e;new e,r.prototype.forEachWorldCorner=function(t,i,s){for(var a=this.halfExtents,c=[[a.x,a.y,a.z],[-a.x,a.y,a.z],[-a.x,-a.y,a.z],[-a.x,-a.y,-a.z],[a.x,-a.y,-a.z],[a.x,a.y,-a.z],[-a.x,a.y,-a.z],[a.x,-a.y,a.z]],h=0;h<c.length;h++)l.set(c[h][0],c[h][1],c[h][2]),i.vmult(l,l),t.vadd(l,l),s(l.x,l.y,l.z)};var o=[new e,new e,new e,new e,new e,new e,new e,new e];r.prototype.calculateWorldAABB=function(t,i,s,a){var c=this.halfExtents;o[0].set(c.x,c.y,c.z),o[1].set(-c.x,c.y,c.z),o[2].set(-c.x,-c.y,c.z),o[3].set(-c.x,-c.y,-c.z),o[4].set(c.x,-c.y,-c.z),o[5].set(c.x,c.y,-c.z),o[6].set(-c.x,c.y,-c.z),o[7].set(c.x,-c.y,c.z);var h=o[0];i.vmult(h,h),t.vadd(h,h),a.copy(h),s.copy(h);for(var u=1;u<8;u++){var h=o[u];i.vmult(h,h),t.vadd(h,h);var f=h.x,w=h.y,d=h.z;f>a.x&&(a.x=f),w>a.y&&(a.y=w),d>a.z&&(a.z=d),f<s.x&&(s.x=f),w<s.y&&(s.y=w),d<s.z&&(s.z=d)}}},{"../math/Vec3":30,"./ConvexPolyhedron":38,"./Shape":43}],38:[function(v,I,ht){I.exports=r;var p=v("./Shape"),e=v("../math/Vec3");v("../math/Quaternion");var n=v("../math/Transform");function r(g,P,x){p.call(this),this.type=p.types.CONVEXPOLYHEDRON,this.vertices=g||[],this.worldVertices=[],this.worldVerticesNeedsUpdate=!0,this.faces=P||[],this.faceNormals=[],this.computeNormals(),this.worldFaceNormalsNeedsUpdate=!0,this.worldFaceNormals=[],this.uniqueEdges=[],this.uniqueAxes=x?x.slice():null,this.computeEdges(),this.updateBoundingSphereRadius()}r.prototype=new p,r.prototype.constructor=r;var l=new e;r.prototype.computeEdges=function(){var g=this.faces,P=this.vertices;P.length;var x=this.uniqueEdges;x.length=0;for(var m=l,y=0;y!==g.length;y++)for(var A=g[y],O=A.length,N=0;N!==O;N++){var C=(N+1)%O;P[A[N]].vsub(P[A[C]],m),m.normalize();for(var W=!1,X=0;X!==x.length;X++)if(x[X].almostEquals(m)||x[X].almostEquals(m)){W=!0;break}W||x.push(m.clone())}},r.prototype.computeNormals=function(){this.faceNormals.length=this.faces.length;for(var g=0;g<this.faces.length;g++){for(var P=0;P<this.faces[g].length;P++)if(!this.vertices[this.faces[g][P]])throw new Error("Vertex "+this.faces[g][P]+" not found!");var x=this.faceNormals[g]||new e;this.getFaceNormal(g,x),x.negate(x),this.faceNormals[g]=x;var m=this.vertices[this.faces[g][0]];if(x.dot(m)<0){console.error(".faceNormals["+g+"] = Vec3("+x.toString()+") looks like it points into the shape? The vertices follow. Make sure they are ordered CCW around the normal, using the right hand rule.");for(var P=0;P<this.faces[g].length;P++)console.warn(".vertices["+this.faces[g][P]+"] = Vec3("+this.vertices[this.faces[g][P]].toString()+")")}}};var o=new e,t=new e;r.computeNormal=function(g,P,x,m){P.vsub(g,t),x.vsub(P,o),o.cross(t,m),m.isZero()||m.normalize()},r.prototype.getFaceNormal=function(g,P){var x=this.faces[g],m=this.vertices[x[0]],y=this.vertices[x[1]],A=this.vertices[x[2]];return r.computeNormal(m,y,A,P)};var i=new e;r.prototype.clipAgainstHull=function(g,P,x,m,y,A,O,N,C){for(var W=i,X=-1,ct=-Number.MAX_VALUE,st=0;st<x.faces.length;st++){W.copy(x.faceNormals[st]),y.vmult(W,W);var nt=W.dot(A);nt>ct&&(ct=nt,X=st)}for(var q=[],Q=x.faces[X],Ct=Q.length,dt=0;dt<Ct;dt++){var Mt=x.vertices[Q[dt]],vt=new e;vt.copy(Mt),y.vmult(vt,vt),m.vadd(vt,vt),q.push(vt)}X>=0&&this.clipFaceAgainstHull(A,g,P,q,O,N,C)};var s=new e,a=new e,c=new e,h=new e,u=new e,f=new e;r.prototype.findSeparatingAxis=function(g,P,x,m,y,A,O,N){var C=s,W=a,X=c,ct=h,st=u,nt=f,q=Number.MAX_VALUE,Q=this;if(Q.uniqueAxes)for(var dt=0;dt!==Q.uniqueAxes.length;dt++){x.vmult(Q.uniqueAxes[dt],C);var vt=Q.testSepAxis(C,g,P,x,m,y);if(vt===!1)return!1;vt<q&&(q=vt,A.copy(C))}else for(var Ct=O?O.length:Q.faces.length,dt=0;dt<Ct;dt++){var Mt=O?O[dt]:dt;C.copy(Q.faceNormals[Mt]),x.vmult(C,C);var vt=Q.testSepAxis(C,g,P,x,m,y);if(vt===!1)return!1;vt<q&&(q=vt,A.copy(C))}if(g.uniqueAxes)for(var dt=0;dt!==g.uniqueAxes.length;dt++){y.vmult(g.uniqueAxes[dt],W);var vt=Q.testSepAxis(W,g,P,x,m,y);if(vt===!1)return!1;vt<q&&(q=vt,A.copy(W))}else for(var At=N?N.length:g.faces.length,dt=0;dt<At;dt++){var Mt=N?N[dt]:dt;W.copy(g.faceNormals[Mt]),y.vmult(W,W);var vt=Q.testSepAxis(W,g,P,x,m,y);if(vt===!1)return!1;vt<q&&(q=vt,A.copy(W))}for(var gt=0;gt!==Q.uniqueEdges.length;gt++){x.vmult(Q.uniqueEdges[gt],ct);for(var zt=0;zt!==g.uniqueEdges.length;zt++)if(y.vmult(g.uniqueEdges[zt],st),ct.cross(st,nt),!nt.almostZero()){nt.normalize();var Vt=Q.testSepAxis(nt,g,P,x,m,y);if(Vt===!1)return!1;Vt<q&&(q=Vt,A.copy(nt))}}return m.vsub(P,X),X.dot(A)>0&&A.negate(A),!0};var w=[],d=[];r.prototype.testSepAxis=function(g,P,x,m,y,A){var O=this;r.project(O,g,x,m,w),r.project(P,g,y,A,d);var N=w[0],C=w[1],W=d[0],X=d[1];if(N<X||W<C)return!1;var ct=N-X,st=W-C,nt=ct<st?ct:st;return nt};var b=new e,k=new e;r.prototype.calculateLocalInertia=function(g,P){this.computeLocalAABB(b,k);var x=k.x-b.x,m=k.y-b.y,y=k.z-b.z;P.x=1/12*g*(2*m*2*m+2*y*2*y),P.y=1/12*g*(2*x*2*x+2*y*2*y),P.z=1/12*g*(2*m*2*m+2*x*2*x)},r.prototype.getPlaneConstantOfFace=function(g){var P=this.faces[g],x=this.faceNormals[g],m=this.vertices[P[0]],y=-x.dot(m);return y};var at=new e,T=new e,H=new e,z=new e,B=new e,R=new e,D=new e,$=new e;r.prototype.clipFaceAgainstHull=function(g,P,x,m,y,A,O){for(var N=at,C=T,W=H,X=z,ct=B,st=R,nt=D,q=$,Q=this,Ct=[],dt=m,Mt=Ct,vt=-1,At=Number.MAX_VALUE,gt=0;gt<Q.faces.length;gt++){N.copy(Q.faceNormals[gt]),x.vmult(N,N);var zt=N.dot(g);zt<At&&(At=zt,vt=gt)}if(!(vt<0)){var Vt=Q.faces[vt];Vt.connectedFaces=[];for(var St=0;St<Q.faces.length;St++)for(var Nt=0;Nt<Q.faces[St].length;Nt++)Vt.indexOf(Q.faces[St][Nt])!==-1&&St!==vt&&Vt.connectedFaces.indexOf(St)===-1&&Vt.connectedFaces.push(St);dt.length;for(var qt=Vt.length,Et=0;Et<qt;Et++){var kt=Q.vertices[Vt[Et]],oe=Q.vertices[Vt[(Et+1)%qt]];kt.vsub(oe,C),W.copy(C),x.vmult(W,W),P.vadd(W,W),X.copy(this.faceNormals[vt]),x.vmult(X,X),P.vadd(X,X),W.cross(X,ct),ct.negate(ct),st.copy(kt),x.vmult(st,st),P.vadd(st,st),-st.dot(ct);var te;{var he=Vt.connectedFaces[Et];nt.copy(this.faceNormals[he]);var re=this.getPlaneConstantOfFace(he);q.copy(nt),x.vmult(q,q);var te=re-q.dot(P)}for(this.clipFaceAgainstPlane(dt,Mt,q,te);dt.length;)dt.shift();for(;Mt.length;)dt.push(Mt.shift())}nt.copy(this.faceNormals[vt]);var re=this.getPlaneConstantOfFace(vt);q.copy(nt),x.vmult(q,q);for(var te=re-q.dot(P),St=0;St<dt.length;St++){var Qt=q.dot(dt[St])+te;if(Qt<=y&&(console.log("clamped: depth="+Qt+" to minDist="+(y+"")),Qt=y),Qt<=A){var ue=dt[St];if(Qt<=0){var ce={point:ue,normal:q,depth:Qt};O.push(ce)}}}}},r.prototype.clipFaceAgainstPlane=function(g,P,x,m){var y,A,O=g.length;if(O<2)return P;var N=g[g.length-1],C=g[0];y=x.dot(N)+m;for(var W=0;W<O;W++){if(C=g[W],A=x.dot(C)+m,y<0)if(A<0){var X=new e;X.copy(C),P.push(X)}else{var X=new e;N.lerp(C,y/(y-A),X),P.push(X)}else if(A<0){var X=new e;N.lerp(C,y/(y-A),X),P.push(X),P.push(C)}N=C,y=A}return P},r.prototype.computeWorldVertices=function(g,P){for(var x=this.vertices.length;this.worldVertices.length<x;)this.worldVertices.push(new e);for(var m=this.vertices,y=this.worldVertices,A=0;A!==x;A++)P.vmult(m[A],y[A]),g.vadd(y[A],y[A]);this.worldVerticesNeedsUpdate=!1},new e,r.prototype.computeLocalAABB=function(g,P){var x=this.vertices.length,m=this.vertices;g.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),P.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var y=0;y<x;y++){var A=m[y];A.x<g.x?g.x=A.x:A.x>P.x&&(P.x=A.x),A.y<g.y?g.y=A.y:A.y>P.y&&(P.y=A.y),A.z<g.z?g.z=A.z:A.z>P.z&&(P.z=A.z)}},r.prototype.computeWorldFaceNormals=function(g){for(var P=this.faceNormals.length;this.worldFaceNormals.length<P;)this.worldFaceNormals.push(new e);for(var x=this.faceNormals,m=this.worldFaceNormals,y=0;y!==P;y++)g.vmult(x[y],m[y]);this.worldFaceNormalsNeedsUpdate=!1},r.prototype.updateBoundingSphereRadius=function(){for(var g=0,P=this.vertices,x=0,m=P.length;x!==m;x++){var y=P[x].norm2();y>g&&(g=y)}this.boundingSphereRadius=Math.sqrt(g)};var K=new e;r.prototype.calculateWorldAABB=function(g,P,x,m){for(var y=this.vertices.length,A=this.vertices,O,N,C,W,X,ct,st=0;st<y;st++){K.copy(A[st]),P.vmult(K,K),g.vadd(K,K);var nt=K;nt.x<O||O===void 0?O=nt.x:(nt.x>W||W===void 0)&&(W=nt.x),nt.y<N||N===void 0?N=nt.y:(nt.y>X||X===void 0)&&(X=nt.y),nt.z<C||C===void 0?C=nt.z:(nt.z>ct||ct===void 0)&&(ct=nt.z)}x.set(O,N,C),m.set(W,X,ct)},r.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},r.prototype.getAveragePointLocal=function(g){g=g||new e;for(var P=this.vertices.length,x=this.vertices,m=0;m<P;m++)g.vadd(x[m],g);return g.mult(1/P,g),g},r.prototype.transformAllPoints=function(g,P){var x=this.vertices.length,m=this.vertices;if(P){for(var y=0;y<x;y++){var A=m[y];P.vmult(A,A)}for(var y=0;y<this.faceNormals.length;y++){var A=this.faceNormals[y];P.vmult(A,A)}}if(g)for(var y=0;y<x;y++){var A=m[y];A.vadd(g,A)}};var ut=new e,M=new e,E=new e;r.prototype.pointIsInside=function(g){var P=this.vertices.length,x=this.vertices,m=this.faces,y=this.faceNormals,A=null,O=this.faces.length,N=ut;this.getAveragePointLocal(N);for(var C=0;C<O;C++){this.faces[C].length;var P=y[C],W=x[m[C][0]],X=M;g.vsub(W,X);var ct=P.dot(X),st=E;N.vsub(W,st);var nt=P.dot(st);if(ct<0&&nt>0||ct>0&&nt<0)return!1}return A?1:-1},new e;var _=new e,L=new e;r.project=function(g,P,x,m,y){var A=g.vertices.length,O=_,N=0,C=0,W=L,X=g.vertices;W.setZero(),n.vectorToLocalFrame(x,m,P,O),n.pointToLocalFrame(x,m,W,W);var ct=W.dot(O);C=N=X[0].dot(O);for(var st=1;st<A;st++){var nt=X[st].dot(O);nt>N&&(N=nt),nt<C&&(C=nt)}if(C-=ct,N-=ct,C>N){var q=C;C=N,N=q}y[0]=N,y[1]=C}},{"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"./Shape":43}],39:[function(v,I,ht){I.exports=r;var p=v("./Shape"),e=v("../math/Vec3");v("../math/Quaternion");var n=v("./ConvexPolyhedron");function r(l,o,t,i){var s=i,a=[],c=[],h=[],u=[],f=[],w=Math.cos,d=Math.sin;a.push(new e(o*w(0),o*d(0),-t*.5)),u.push(0),a.push(new e(l*w(0),l*d(0),t*.5)),f.push(1);for(var b=0;b<s;b++){var k=2*Math.PI/s*(b+1),at=2*Math.PI/s*(b+.5);b<s-1?(a.push(new e(o*w(k),o*d(k),-t*.5)),u.push(2*b+2),a.push(new e(l*w(k),l*d(k),t*.5)),f.push(2*b+3),h.push([2*b+2,2*b+3,2*b+1,2*b])):h.push([0,1,2*b+1,2*b]),(s%2==1||b<s/2)&&c.push(new e(w(at),d(at),0))}h.push(f),c.push(new e(0,0,1));for(var T=[],b=0;b<u.length;b++)T.push(u[u.length-b-1]);h.push(T),this.type=p.types.CONVEXPOLYHEDRON,n.call(this,a,h,c)}r.prototype=new n},{"../math/Quaternion":28,"../math/Vec3":30,"./ConvexPolyhedron":38,"./Shape":43}],40:[function(v,I,ht){var p=v("./Shape"),e=v("./ConvexPolyhedron"),n=v("../math/Vec3"),r=v("../utils/Utils");I.exports=l;function l(o,t){t=r.defaults(t,{maxValue:null,minValue:null,elementSize:1}),this.data=o,this.maxValue=t.maxValue,this.minValue=t.minValue,this.elementSize=t.elementSize,t.minValue===null&&this.updateMinValue(),t.maxValue===null&&this.updateMaxValue(),this.cacheEnabled=!0,p.call(this),this.pillarConvex=new e,this.pillarOffset=new n,this.type=p.types.HEIGHTFIELD,this.updateBoundingSphereRadius(),this._cachedPillars={}}l.prototype=new p,l.prototype.update=function(){this._cachedPillars={}},l.prototype.updateMinValue=function(){for(var o=this.data,t=o[0][0],i=0;i!==o.length;i++)for(var s=0;s!==o[i].length;s++){var a=o[i][s];a<t&&(t=a)}this.minValue=t},l.prototype.updateMaxValue=function(){for(var o=this.data,t=o[0][0],i=0;i!==o.length;i++)for(var s=0;s!==o[i].length;s++){var a=o[i][s];a>t&&(t=a)}this.maxValue=t},l.prototype.setHeightValueAtIndex=function(o,t,i){var s=this.data;s[o][t]=i,this.clearCachedConvexTrianglePillar(o,t,!1),o>0&&(this.clearCachedConvexTrianglePillar(o-1,t,!0),this.clearCachedConvexTrianglePillar(o-1,t,!1)),t>0&&(this.clearCachedConvexTrianglePillar(o,t-1,!0),this.clearCachedConvexTrianglePillar(o,t-1,!1)),t>0&&o>0&&this.clearCachedConvexTrianglePillar(o-1,t-1,!0)},l.prototype.getRectMinMax=function(o,t,i,s,a){a=a||[];for(var c=this.data,h=this.minValue,u=o;u<=i;u++)for(var f=t;f<=s;f++){var w=c[u][f];w>h&&(h=w)}a[0]=this.minValue,a[1]=h},l.prototype.getIndexOfPosition=function(o,t,i,s){var a=this.elementSize,c=this.data,h=Math.floor(o/a),u=Math.floor(t/a);return i[0]=h,i[1]=u,s&&(h<0&&(h=0),u<0&&(u=0),h>=c.length-1&&(h=c.length-1),u>=c[0].length-1&&(u=c[0].length-1)),!(h<0||u<0||h>=c.length-1||u>=c[0].length-1)},l.prototype.getHeightAt=function(o,t,i){var s=[];this.getIndexOfPosition(o,t,s,i);var a=[];return this.getRectMinMax(s[0],s[1]+1,s[0],s[1]+1,a),(a[0]+a[1])/2},l.prototype.getCacheConvexTrianglePillarKey=function(o,t,i){return o+"_"+t+"_"+(i?1:0)},l.prototype.getCachedConvexTrianglePillar=function(o,t,i){return this._cachedPillars[this.getCacheConvexTrianglePillarKey(o,t,i)]},l.prototype.setCachedConvexTrianglePillar=function(o,t,i,s,a){this._cachedPillars[this.getCacheConvexTrianglePillarKey(o,t,i)]={convex:s,offset:a}},l.prototype.clearCachedConvexTrianglePillar=function(o,t,i){delete this._cachedPillars[this.getCacheConvexTrianglePillarKey(o,t,i)]},l.prototype.getConvexTrianglePillar=function(o,t,i){var s=this.pillarConvex,a=this.pillarOffset;if(this.cacheEnabled){var c=this.getCachedConvexTrianglePillar(o,t,i);if(c){this.pillarConvex=c.convex,this.pillarOffset=c.offset;return}s=new e,a=new n,this.pillarConvex=s,this.pillarOffset=a}var c=this.data,h=this.elementSize,u=s.faces;s.vertices.length=6;for(var f=0;f<6;f++)s.vertices[f]||(s.vertices[f]=new n);u.length=5;for(var f=0;f<5;f++)u[f]||(u[f]=[]);var w=s.vertices,d=(Math.min(c[o][t],c[o+1][t],c[o][t+1],c[o+1][t+1])-this.minValue)/2+this.minValue;i?(a.set((o+.75)*h,(t+.75)*h,d),w[0].set(.25*h,.25*h,c[o+1][t+1]-d),w[1].set(-.75*h,.25*h,c[o][t+1]-d),w[2].set(.25*h,-.75*h,c[o+1][t]-d),w[3].set(.25*h,.25*h,-d-1),w[4].set(-.75*h,.25*h,-d-1),w[5].set(.25*h,-.75*h,-d-1),u[0][0]=0,u[0][1]=1,u[0][2]=2,u[1][0]=5,u[1][1]=4,u[1][2]=3,u[2][0]=2,u[2][1]=5,u[2][2]=3,u[2][3]=0,u[3][0]=3,u[3][1]=4,u[3][2]=1,u[3][3]=0,u[4][0]=1,u[4][1]=4,u[4][2]=5,u[4][3]=2):(a.set((o+.25)*h,(t+.25)*h,d),w[0].set(-.25*h,-.25*h,c[o][t]-d),w[1].set(.75*h,-.25*h,c[o+1][t]-d),w[2].set(-.25*h,.75*h,c[o][t+1]-d),w[3].set(-.25*h,-.25*h,-d-1),w[4].set(.75*h,-.25*h,-d-1),w[5].set(-.25*h,.75*h,-d-1),u[0][0]=0,u[0][1]=1,u[0][2]=2,u[1][0]=5,u[1][1]=4,u[1][2]=3,u[2][0]=0,u[2][1]=2,u[2][2]=5,u[2][3]=3,u[3][0]=1,u[3][1]=0,u[3][2]=3,u[3][3]=4,u[4][0]=4,u[4][1]=5,u[4][2]=2,u[4][3]=1),s.computeNormals(),s.computeEdges(),s.updateBoundingSphereRadius(),this.setCachedConvexTrianglePillar(o,t,i,s,a)},l.prototype.calculateLocalInertia=function(o,t){return t=t||new n,t.set(0,0,0),t},l.prototype.volume=function(){return Number.MAX_VALUE},l.prototype.calculateWorldAABB=function(o,t,i,s){i.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),s.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)},l.prototype.updateBoundingSphereRadius=function(){var o=this.data,t=this.elementSize;this.boundingSphereRadius=new n(o.length*t,o[0].length*t,Math.max(Math.abs(this.maxValue),Math.abs(this.minValue))).norm()}},{"../math/Vec3":30,"../utils/Utils":53,"./ConvexPolyhedron":38,"./Shape":43}],41:[function(v,I,ht){I.exports=n;var p=v("./Shape"),e=v("../math/Vec3");function n(){p.call(this),this.type=p.types.PARTICLE}n.prototype=new p,n.prototype.constructor=n,n.prototype.calculateLocalInertia=function(r,l){return l=l||new e,l.set(0,0,0),l},n.prototype.volume=function(){return 0},n.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=0},n.prototype.calculateWorldAABB=function(r,l,o,t){o.copy(r),t.copy(r)}},{"../math/Vec3":30,"./Shape":43}],42:[function(v,I,ht){I.exports=n;var p=v("./Shape"),e=v("../math/Vec3");function n(){p.call(this),this.type=p.types.PLANE,this.worldNormal=new e,this.worldNormalNeedsUpdate=!0,this.boundingSphereRadius=Number.MAX_VALUE}n.prototype=new p,n.prototype.constructor=n,n.prototype.computeWorldNormal=function(l){var o=this.worldNormal;o.set(0,0,1),l.vmult(o,o),this.worldNormalNeedsUpdate=!1},n.prototype.calculateLocalInertia=function(l,o){return o=o||new e,o},n.prototype.volume=function(){return Number.MAX_VALUE};var r=new e;n.prototype.calculateWorldAABB=function(l,o,t,i){r.set(0,0,1),o.vmult(r,r);var s=Number.MAX_VALUE;t.set(-s,-s,-s),i.set(s,s,s),r.x===1&&(i.x=l.x),r.y===1&&(i.y=l.y),r.z===1&&(i.z=l.z),r.x===-1&&(t.x=l.x),r.y===-1&&(t.y=l.y),r.z===-1&&(t.z=l.z)},n.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=Number.MAX_VALUE}},{"../math/Vec3":30,"./Shape":43}],43:[function(v,I,ht){I.exports=p;var p=v("./Shape");v("../math/Vec3"),v("../math/Quaternion"),v("../material/Material");function p(){this.id=p.idCounter++,this.type=0,this.boundingSphereRadius=0,this.collisionResponse=!0,this.material=null}p.prototype.constructor=p,p.prototype.updateBoundingSphereRadius=function(){throw"computeBoundingSphereRadius() not implemented for shape type "+this.type},p.prototype.volume=function(){throw"volume() not implemented for shape type "+this.type},p.prototype.calculateLocalInertia=function(e,n){throw"calculateLocalInertia() not implemented for shape type "+this.type},p.idCounter=0,p.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16,HEIGHTFIELD:32,PARTICLE:64,CYLINDER:128,TRIMESH:256}},{"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"./Shape":43}],44:[function(v,I,ht){I.exports=n;var p=v("./Shape"),e=v("../math/Vec3");function n(r){if(p.call(this),this.radius=r!==void 0?Number(r):1,this.type=p.types.SPHERE,this.radius<0)throw new Error("The sphere radius cannot be negative.");this.updateBoundingSphereRadius()}n.prototype=new p,n.prototype.constructor=n,n.prototype.calculateLocalInertia=function(r,l){l=l||new e;var o=2*r*this.radius*this.radius/5;return l.x=o,l.y=o,l.z=o,l},n.prototype.volume=function(){return 4*Math.PI*this.radius/3},n.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.radius},n.prototype.calculateWorldAABB=function(r,l,o,t){for(var i=this.radius,s=["x","y","z"],a=0;a<s.length;a++){var c=s[a];o[c]=r[c]-i,t[c]=r[c]+i}}},{"../math/Vec3":30,"./Shape":43}],45:[function(v,I,ht){I.exports=o;var p=v("./Shape"),e=v("../math/Vec3");v("../math/Quaternion");var n=v("../math/Transform"),r=v("../collision/AABB"),l=v("../utils/Octree");function o(T,H){p.call(this),this.type=p.types.TRIMESH,this.vertices=new Float32Array(T),this.indices=new Int16Array(H),this.normals=new Float32Array(H.length),this.aabb=new r,this.edges=null,this.scale=new e(1,1,1),this.tree=new l,this.updateEdges(),this.updateNormals(),this.updateAABB(),this.updateBoundingSphereRadius(),this.updateTree()}o.prototype=new p,o.prototype.constructor=o;var t=new e;o.prototype.updateTree=function(){var T=this.tree;T.reset(),T.aabb.copy(this.aabb);var H=this.scale;T.aabb.lowerBound.x*=1/H.x,T.aabb.lowerBound.y*=1/H.y,T.aabb.lowerBound.z*=1/H.z,T.aabb.upperBound.x*=1/H.x,T.aabb.upperBound.y*=1/H.y,T.aabb.upperBound.z*=1/H.z;for(var z=new r,B=new e,R=new e,D=new e,$=[B,R,D],K=0;K<this.indices.length/3;K++){var ut=K*3;this._getUnscaledVertex(this.indices[ut],B),this._getUnscaledVertex(this.indices[ut+1],R),this._getUnscaledVertex(this.indices[ut+2],D),z.setFromPoints($),T.insert(z,K)}T.removeEmptyNodes()};var i=new r;o.prototype.getTrianglesInAABB=function(T,H){i.copy(T);var z=this.scale,B=z.x,R=z.y,D=z.z,$=i.lowerBound,K=i.upperBound;return $.x/=B,$.y/=R,$.z/=D,K.x/=B,K.y/=R,K.z/=D,this.tree.aabbQuery(i,H)},o.prototype.setScale=function(T){var H=this.scale.x===this.scale.y===this.scale.z,z=T.x===T.y===T.z;H&&z||this.updateNormals(),this.scale.copy(T),this.updateAABB(),this.updateBoundingSphereRadius()},o.prototype.updateNormals=function(){for(var T=t,H=this.normals,z=0;z<this.indices.length/3;z++){var B=z*3,R=this.indices[B],D=this.indices[B+1],$=this.indices[B+2];this.getVertex(R,u),this.getVertex(D,f),this.getVertex($,w),o.computeNormal(f,u,w,T),H[B]=T.x,H[B+1]=T.y,H[B+2]=T.z}},o.prototype.updateEdges=function(){for(var T={},H=function(ut,M){var E=R<D?R+"_"+D:D+"_"+R;T[E]=!0},z=0;z<this.indices.length/3;z++){var B=z*3,R=this.indices[B],D=this.indices[B+1];this.indices[B+2],H(),H(),H()}var $=Object.keys(T);this.edges=new Int16Array($.length*2);for(var z=0;z<$.length;z++){var K=$[z].split("_");this.edges[2*z]=parseInt(K[0],10),this.edges[2*z+1]=parseInt(K[1],10)}},o.prototype.getEdgeVertex=function(T,H,z){var B=this.edges[T*2+(H?1:0)];this.getVertex(B,z)};var s=new e,a=new e;o.prototype.getEdgeVector=function(T,H){var z=s,B=a;this.getEdgeVertex(T,0,z),this.getEdgeVertex(T,1,B),B.vsub(z,H)};var c=new e,h=new e;o.computeNormal=function(T,H,z,B){H.vsub(T,h),z.vsub(H,c),c.cross(h,B),B.isZero()||B.normalize()};var u=new e,f=new e,w=new e;o.prototype.getVertex=function(T,H){var z=this.scale;return this._getUnscaledVertex(T,H),H.x*=z.x,H.y*=z.y,H.z*=z.z,H},o.prototype._getUnscaledVertex=function(T,H){var z=T*3,B=this.vertices;return H.set(B[z],B[z+1],B[z+2])},o.prototype.getWorldVertex=function(T,H,z,B){return this.getVertex(T,B),n.pointToWorldFrame(H,z,B,B),B},o.prototype.getTriangleVertices=function(T,H,z,B){var R=T*3;this.getVertex(this.indices[R],H),this.getVertex(this.indices[R+1],z),this.getVertex(this.indices[R+2],B)},o.prototype.getNormal=function(T,H){var z=T*3;return H.set(this.normals[z],this.normals[z+1],this.normals[z+2])};var d=new r;o.prototype.calculateLocalInertia=function(T,H){this.computeLocalAABB(d);var z=d.upperBound.x-d.lowerBound.x,B=d.upperBound.y-d.lowerBound.y,R=d.upperBound.z-d.lowerBound.z;return H.set(1/12*T*(2*B*2*B+2*R*2*R),1/12*T*(2*z*2*z+2*R*2*R),1/12*T*(2*B*2*B+2*z*2*z))};var b=new e;o.prototype.computeLocalAABB=function(T){var H=T.lowerBound,z=T.upperBound,B=this.vertices.length;this.vertices;var R=b;this.getVertex(0,R),H.copy(R),z.copy(R);for(var D=0;D!==B;D++)this.getVertex(D,R),R.x<H.x?H.x=R.x:R.x>z.x&&(z.x=R.x),R.y<H.y?H.y=R.y:R.y>z.y&&(z.y=R.y),R.z<H.z?H.z=R.z:R.z>z.z&&(z.z=R.z)},o.prototype.updateAABB=function(){this.computeLocalAABB(this.aabb)},o.prototype.updateBoundingSphereRadius=function(){for(var T=0,H=this.vertices,z=new e,B=0,R=H.length/3;B!==R;B++){this.getVertex(B,z);var D=z.norm2();D>T&&(T=D)}this.boundingSphereRadius=Math.sqrt(T)},new e;var k=new n,at=new r;o.prototype.calculateWorldAABB=function(T,H,z,B){var R=k,D=at;R.position=T,R.quaternion=H,this.aabb.toWorldFrame(R,D),z.copy(D.lowerBound),B.copy(D.upperBound)},o.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},o.createTorus=function(T,H,z,B,R){T=T||1,H=H||.5,z=z||8,B=B||6,R=R||Math.PI*2;for(var D=[],$=[],K=0;K<=z;K++)for(var ut=0;ut<=B;ut++){var M=ut/B*R,E=K/z*Math.PI*2,_=(T+H*Math.cos(E))*Math.cos(M),L=(T+H*Math.cos(E))*Math.sin(M),g=H*Math.sin(E);D.push(_,L,g)}for(var K=1;K<=z;K++)for(var ut=1;ut<=B;ut++){var P=(B+1)*K+ut-1,x=(B+1)*(K-1)+ut-1,m=(B+1)*(K-1)+ut,y=(B+1)*K+ut;$.push(P,x,y),$.push(x,m,y)}return new o(D,$)}},{"../collision/AABB":3,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../utils/Octree":50,"./Shape":43}],46:[function(v,I,ht){I.exports=e,v("../math/Vec3"),v("../math/Quaternion");var p=v("./Solver");function e(){p.call(this),this.iterations=10,this.tolerance=1e-7}e.prototype=new p;var n=[],r=[],l=[];e.prototype.solve=function(o,t){var i=0,s=this.iterations,a=this.tolerance*this.tolerance,c=this.equations,h=c.length,u=t.bodies,f=u.length,w=o,d,b,k,at,T,H;if(h!==0)for(var z=0;z!==f;z++)u[z].updateSolveMassProperties();var B=r,R=l,D=n;B.length=h,R.length=h,D.length=h;for(var z=0;z!==h;z++){var $=c[z];D[z]=0,R[z]=$.computeB(w),B[z]=1/$.computeC()}if(h!==0){for(var z=0;z!==f;z++){var K=u[z],ut=K.vlambda,M=K.wlambda;ut.set(0,0,0),M&&M.set(0,0,0)}for(i=0;i!==s;i++){at=0;for(var E=0;E!==h;E++){var $=c[E];d=R[E],b=B[E],H=D[E],T=$.computeGWlambda(),k=b*(d-T-$.eps*H),H+k<$.minForce?k=$.minForce-H:H+k>$.maxForce&&(k=$.maxForce-H),D[E]+=k,at+=k>0?k:-k,$.addToWlambda(k)}if(at*at<a)break}for(var z=0;z!==f;z++){var K=u[z],_=K.velocity,L=K.angularVelocity;_.vadd(K.vlambda,_),L&&L.vadd(K.wlambda,L)}}return i}},{"../math/Quaternion":28,"../math/Vec3":30,"./Solver":47}],47:[function(v,I,ht){I.exports=p;function p(){this.equations=[]}p.prototype.solve=function(e,n){return 0},p.prototype.addEquation=function(e){e.enabled&&this.equations.push(e)},p.prototype.removeEquation=function(e){var n=this.equations,r=n.indexOf(e);r!==-1&&n.splice(r,1)},p.prototype.removeAllEquations=function(){this.equations.length=0}},{}],48:[function(v,I,ht){I.exports=n,v("../math/Vec3"),v("../math/Quaternion");var p=v("./Solver"),e=v("../objects/Body");function n(u){for(p.call(this),this.iterations=10,this.tolerance=1e-7,this.subsolver=u,this.nodes=[],this.nodePool=[];this.nodePool.length<128;)this.nodePool.push(this.createNode())}n.prototype=new p;var r=[],l=[],o={bodies:[]},t=e.STATIC;function i(u){for(var f=u.length,w=0;w!==f;w++){var d=u[w];if(!d.visited&&!(d.body.type&t))return d}return!1}var s=[];function a(u,f,w,d){for(s.push(u),u.visited=!0,f(u,w,d);s.length;)for(var b=s.pop(),k;k=i(b.children);)k.visited=!0,f(k,w,d),s.push(k)}function c(u,f,w){f.push(u.body);for(var d=u.eqs.length,b=0;b!==d;b++){var k=u.eqs[b];w.indexOf(k)===-1&&w.push(k)}}n.prototype.createNode=function(){return{body:null,children:[],eqs:[],visited:!1}},n.prototype.solve=function(u,f){for(var w=r,d=this.nodePool,b=f.bodies,k=this.equations,at=k.length,T=b.length,H=this.subsolver;d.length<T;)d.push(this.createNode());w.length=T;for(var z=0;z<T;z++)w[z]=d[z];for(var z=0;z!==T;z++){var B=w[z];B.body=b[z],B.children.length=0,B.eqs.length=0,B.visited=!1}for(var R=0;R!==at;R++){var D=k[R],z=b.indexOf(D.bi),$=b.indexOf(D.bj),K=w[z],ut=w[$];K.children.push(ut),K.eqs.push(D),ut.children.push(K),ut.eqs.push(D)}var M,E=0,_=l;H.tolerance=this.tolerance,H.iterations=this.iterations;for(var L=o;M=i(w);){_.length=0,L.bodies.length=0,a(M,c,L.bodies,_);var g=_.length;_=_.sort(h);for(var z=0;z!==g;z++)H.addEquation(_[z]);H.solve(u,L),H.removeAllEquations(),E++}return E};function h(u,f){return f.id-u.id}},{"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"./Solver":47}],49:[function(v,I,ht){var p=function(){};I.exports=p,p.prototype={constructor:p,addEventListener:function(e,n){this._listeners===void 0&&(this._listeners={});var r=this._listeners;return r[e]===void 0&&(r[e]=[]),r[e].indexOf(n)===-1&&r[e].push(n),this},hasEventListener:function(e,n){if(this._listeners===void 0)return!1;var r=this._listeners;return r[e]!==void 0&&r[e].indexOf(n)!==-1},removeEventListener:function(e,n){if(this._listeners===void 0)return this;var r=this._listeners;if(r[e]===void 0)return this;var l=r[e].indexOf(n);return l!==-1&&r[e].splice(l,1),this},dispatchEvent:function(e){if(this._listeners===void 0)return this;var n=this._listeners,r=n[e.type];if(r!==void 0){e.target=this;for(var l=0,o=r.length;l<o;l++)r[l].call(this,e)}return this}}},{}],50:[function(v,I,ht){var p=v("../collision/AABB"),e=v("../math/Vec3");I.exports=r;function n(t){t=t||{},this.root=t.root||null,this.aabb=t.aabb?t.aabb.clone():new p,this.data=[],this.children=[]}function r(t,i){i=i||{},i.root=null,i.aabb=t,n.call(this,i),this.maxDepth=typeof i.maxDepth!="undefined"?i.maxDepth:8}r.prototype=new n,n.prototype.reset=function(t,i){this.children.length=this.data.length=0},n.prototype.insert=function(t,i,s){var a=this.data;if(s=s||0,!this.aabb.contains(t))return!1;var c=this.children;if(s<(this.maxDepth||this.root.maxDepth)){var h=!1;c.length||(this.subdivide(),h=!0);for(var u=0;u!==8;u++)if(c[u].insert(t,i,s+1))return!0;h&&(c.length=0)}return a.push(i),!0};var l=new e;n.prototype.subdivide=function(){var t=this.aabb,i=t.lowerBound,s=t.upperBound,a=this.children;a.push(new n({aabb:new p({lowerBound:new e(0,0,0)})}),new n({aabb:new p({lowerBound:new e(1,0,0)})}),new n({aabb:new p({lowerBound:new e(1,1,0)})}),new n({aabb:new p({lowerBound:new e(1,1,1)})}),new n({aabb:new p({lowerBound:new e(0,1,1)})}),new n({aabb:new p({lowerBound:new e(0,0,1)})}),new n({aabb:new p({lowerBound:new e(1,0,1)})}),new n({aabb:new p({lowerBound:new e(0,1,0)})})),s.vsub(i,l),l.scale(.5,l);for(var c=this.root||this,h=0;h!==8;h++){var u=a[h];u.root=c;var f=u.aabb.lowerBound;f.x*=l.x,f.y*=l.y,f.z*=l.z,f.vadd(i,f),f.vadd(l,u.aabb.upperBound)}},n.prototype.aabbQuery=function(t,i){this.data,this.children;for(var s=[this];s.length;){var a=s.pop();a.aabb.overlaps(t)&&Array.prototype.push.apply(i,a.data),Array.prototype.push.apply(s,a.children)}return i};var o=new p;n.prototype.rayQuery=function(t,i,s){return t.getAABB(o),o.toLocalFrame(i,o),this.aabbQuery(o,s),s},n.prototype.removeEmptyNodes=function(){for(var t=[this];t.length;){for(var i=t.pop(),s=i.children.length-1;s>=0;s--)i.children[s].data.length||i.children.splice(s,1);Array.prototype.push.apply(t,i.children)}}},{"../collision/AABB":3,"../math/Vec3":30}],51:[function(v,I,ht){I.exports=p;function p(){this.objects=[],this.type=Object}p.prototype.release=function(){for(var e=arguments.length,n=0;n!==e;n++)this.objects.push(arguments[n])},p.prototype.get=function(){return this.objects.length===0?this.constructObject():this.objects.pop()},p.prototype.constructObject=function(){throw new Error("constructObject() not implemented in this Pool subclass yet!")}},{}],52:[function(v,I,ht){I.exports=p;function p(){this.data={keys:[]}}p.prototype.get=function(e,n){if(e>n){var r=n;n=e,e=r}return this.data[e+"-"+n]},p.prototype.set=function(e,n,r){if(e>n){var l=n;n=e,e=l}var o=e+"-"+n;this.get(e,n)||this.data.keys.push(o),this.data[o]=r},p.prototype.reset=function(){for(var e=this.data,n=e.keys;n.length>0;){var r=n.pop();delete e[r]}}},{}],53:[function(v,I,ht){function p(){}I.exports=p,p.defaults=function(e,n){e=e||{};for(var r in n)r in e||(e[r]=n[r]);return e}},{}],54:[function(v,I,ht){I.exports=n;var p=v("../math/Vec3"),e=v("./Pool");function n(){e.call(this),this.type=p}n.prototype=new e,n.prototype.constructObject=function(){return new p}},{"../math/Vec3":30,"./Pool":51}],55:[function(v,I,ht){I.exports=a;var p=v("../collision/AABB"),e=v("../shapes/Shape"),n=v("../collision/Ray"),r=v("../math/Vec3"),l=v("../math/Transform");v("../shapes/ConvexPolyhedron");var o=v("../math/Quaternion");v("../solver/Solver");var t=v("../utils/Vec3Pool"),i=v("../equations/ContactEquation"),s=v("../equations/FrictionEquation");function a(V){this.contactPointPool=[],this.frictionEquationPool=[],this.result=[],this.frictionResult=[],this.v3pool=new t,this.world=V,this.currentContactMaterial=null,this.enableFrictionReduction=!1}a.prototype.createContactEquation=function(V,F,G,U,yt,rt){var j;this.contactPointPool.length?(j=this.contactPointPool.pop(),j.bi=V,j.bj=F):j=new i(V,F),j.enabled=V.collisionResponse&&F.collisionResponse&&G.collisionResponse&&U.collisionResponse;var it=this.currentContactMaterial;j.restitution=it.restitution,j.setSpookParams(it.contactEquationStiffness,it.contactEquationRelaxation,this.world.dt);var S=G.material||V.material,J=U.material||F.material;return S&&J&&S.restitution>=0&&J.restitution>=0&&(j.restitution=S.restitution*J.restitution),j.si=yt||G,j.sj=rt||U,j},a.prototype.createFrictionEquationsFromContact=function(V,F){var G=V.bi,U=V.bj,yt=V.si,rt=V.sj,j=this.world,it=this.currentContactMaterial,S=it.friction,J=yt.material||G.material,ot=rt.material||U.material;if(J&&ot&&J.friction>=0&&ot.friction>=0&&(S=J.friction*ot.friction),S>0){var lt=S*j.gravity.length(),tt=G.invMass+U.invMass;tt>0&&(tt=1/tt);var Z=this.frictionEquationPool,et=Z.length?Z.pop():new s(G,U,lt*tt),pt=Z.length?Z.pop():new s(G,U,lt*tt);return et.bi=pt.bi=G,et.bj=pt.bj=U,et.minForce=pt.minForce=-lt*tt,et.maxForce=pt.maxForce=lt*tt,et.ri.copy(V.ri),et.rj.copy(V.rj),pt.ri.copy(V.ri),pt.rj.copy(V.rj),V.ni.tangents(et.t,pt.t),et.setSpookParams(it.frictionEquationStiffness,it.frictionEquationRelaxation,j.dt),pt.setSpookParams(it.frictionEquationStiffness,it.frictionEquationRelaxation,j.dt),et.enabled=pt.enabled=V.enabled,F.push(et,pt),!0}return!1};var c=new r,h=new r,u=new r;a.prototype.createFrictionFromAverage=function(V){var F=this.result[this.result.length-1];if(!(!this.createFrictionEquationsFromContact(F,this.frictionResult)||V===1)){var G=this.frictionResult[this.frictionResult.length-2],U=this.frictionResult[this.frictionResult.length-1];c.setZero(),h.setZero(),u.setZero();var yt=F.bi;F.bj;for(var rt=0;rt!==V;rt++)F=this.result[this.result.length-1-rt],F.bodyA!==yt?(c.vadd(F.ni,c),h.vadd(F.ri,h),u.vadd(F.rj,u)):(c.vsub(F.ni,c),h.vadd(F.rj,h),u.vadd(F.ri,u));var j=1/V;h.scale(j,G.ri),u.scale(j,G.rj),U.ri.copy(G.ri),U.rj.copy(G.rj),c.normalize(),c.tangents(G.t,U.t)}};var f=new r,w=new r,d=new o,b=new o;a.prototype.getContacts=function(V,F,G,U,yt,rt,j){this.contactPointPool=yt,this.frictionEquationPool=j,this.result=U,this.frictionResult=rt;for(var it=d,S=b,J=f,ot=w,lt=0,tt=V.length;lt!==tt;lt++){var Z=V[lt],et=F[lt],pt=null;Z.material&&et.material&&(pt=G.getContactMaterial(Z.material,et.material)||null);for(var wt=0;wt<Z.shapes.length;wt++){Z.quaternion.mult(Z.shapeOrientations[wt],it),Z.quaternion.vmult(Z.shapeOffsets[wt],J),J.vadd(Z.position,J);for(var Y=Z.shapes[wt],xt=0;xt<et.shapes.length;xt++){et.quaternion.mult(et.shapeOrientations[xt],S),et.quaternion.vmult(et.shapeOffsets[xt],ot),ot.vadd(et.position,ot);var Bt=et.shapes[xt];if(!(J.distanceTo(ot)>Y.boundingSphereRadius+Bt.boundingSphereRadius)){var It=null;Y.material&&Bt.material&&(It=G.getContactMaterial(Y.material,Bt.material)||null),this.currentContactMaterial=It||pt||G.defaultContactMaterial;var bt=this[Y.type|Bt.type];bt&&(Y.type<Bt.type?bt.call(this,Y,Bt,J,ot,it,S,Z,et,Y,Bt):bt.call(this,Bt,Y,ot,J,S,it,et,Z,Y,Bt))}}}}},a.prototype[e.types.BOX|e.types.BOX]=a.prototype.boxBox=function(V,F,G,U,yt,rt,j,it){V.convexPolyhedronRepresentation.material=V.material,F.convexPolyhedronRepresentation.material=F.material,V.convexPolyhedronRepresentation.collisionResponse=V.collisionResponse,F.convexPolyhedronRepresentation.collisionResponse=F.collisionResponse,this.convexConvex(V.convexPolyhedronRepresentation,F.convexPolyhedronRepresentation,G,U,yt,rt,j,it,V,F)},a.prototype[e.types.BOX|e.types.CONVEXPOLYHEDRON]=a.prototype.boxConvex=function(V,F,G,U,yt,rt,j,it){V.convexPolyhedronRepresentation.material=V.material,V.convexPolyhedronRepresentation.collisionResponse=V.collisionResponse,this.convexConvex(V.convexPolyhedronRepresentation,F,G,U,yt,rt,j,it,V,F)},a.prototype[e.types.BOX|e.types.PARTICLE]=a.prototype.boxParticle=function(V,F,G,U,yt,rt,j,it){V.convexPolyhedronRepresentation.material=V.material,V.convexPolyhedronRepresentation.collisionResponse=V.collisionResponse,this.convexParticle(V.convexPolyhedronRepresentation,F,G,U,yt,rt,j,it,V,F)},a.prototype[e.types.SPHERE]=a.prototype.sphereSphere=function(V,F,G,U,yt,rt,j,it){var S=this.createContactEquation(j,it,V,F);U.vsub(G,S.ni),S.ni.normalize(),S.ri.copy(S.ni),S.rj.copy(S.ni),S.ri.mult(V.radius,S.ri),S.rj.mult(-F.radius,S.rj),S.ri.vadd(G,S.ri),S.ri.vsub(j.position,S.ri),S.rj.vadd(U,S.rj),S.rj.vsub(it.position,S.rj),this.result.push(S),this.createFrictionEquationsFromContact(S,this.frictionResult)};var k=new r,at=new r,T=new r;a.prototype[e.types.PLANE|e.types.TRIMESH]=a.prototype.planeTrimesh=function(V,F,G,U,yt,rt,j,it){var S=new r,J=k;J.set(0,0,1),yt.vmult(J,J);for(var ot=0;ot<F.vertices.length/3;ot++){F.getVertex(ot,S);var lt=new r;lt.copy(S),l.pointToWorldFrame(U,rt,lt,S);var tt=at;S.vsub(G,tt);var Z=J.dot(tt);if(Z<=0){var et=this.createContactEquation(j,it,V,F);et.ni.copy(J);var pt=T;J.scale(tt.dot(J),pt),S.vsub(pt,pt),et.ri.copy(pt),et.ri.vsub(j.position,et.ri),et.rj.copy(S),et.rj.vsub(it.position,et.rj),this.result.push(et),this.createFrictionEquationsFromContact(et,this.frictionResult)}}};var H=new r,z=new r;new r;var B=new r,R=new r,D=new r,$=new r,K=new r,ut=new r,M=new r,E=new r,_=new r,L=new r,g=new r,P=new p,x=[];a.prototype[e.types.SPHERE|e.types.TRIMESH]=a.prototype.sphereTrimesh=function(V,F,G,U,yt,rt,j,it){var S=D,J=$,ot=K,lt=ut,tt=M,Z=E,et=P,pt=R,wt=z,Y=x;l.pointToLocalFrame(U,rt,G,tt);var xt=V.radius;et.lowerBound.set(tt.x-xt,tt.y-xt,tt.z-xt),et.upperBound.set(tt.x+xt,tt.y+xt,tt.z+xt),F.getTrianglesInAABB(et,Y);for(var Bt=B,It=V.radius*V.radius,bt=0;bt<Y.length;bt++)for(var Rt=0;Rt<3;Rt++)if(F.getVertex(F.indices[Y[bt]*3+Rt],Bt),Bt.vsub(tt,wt),wt.norm2()<=It){pt.copy(Bt),l.pointToWorldFrame(U,rt,pt,Bt),Bt.vsub(G,wt);var ft=this.createContactEquation(j,it,V,F);ft.ni.copy(wt),ft.ni.normalize(),ft.ri.copy(ft.ni),ft.ri.scale(V.radius,ft.ri),ft.ri.vadd(G,ft.ri),ft.ri.vsub(j.position,ft.ri),ft.rj.copy(Bt),ft.rj.vsub(it.position,ft.rj),this.result.push(ft),this.createFrictionEquationsFromContact(ft,this.frictionResult)}for(var bt=0;bt<Y.length;bt++)for(var Rt=0;Rt<3;Rt++){F.getVertex(F.indices[Y[bt]*3+Rt],S),F.getVertex(F.indices[Y[bt]*3+(Rt+1)%3],J),J.vsub(S,ot),tt.vsub(J,Z);var Zt=Z.dot(ot);tt.vsub(S,Z);var Kt=Z.dot(ot);if(Kt>0&&Zt<0){tt.vsub(S,Z),lt.copy(ot),lt.normalize(),Kt=Z.dot(lt),lt.scale(Kt,Z),Z.vadd(S,Z);var Ut=Z.distanceTo(tt);if(Ut<V.radius){var ft=this.createContactEquation(j,it,V,F);Z.vsub(tt,ft.ni),ft.ni.normalize(),ft.ni.scale(V.radius,ft.ri),l.pointToWorldFrame(U,rt,Z,Z),Z.vsub(it.position,ft.rj),l.vectorToWorldFrame(rt,ft.ni,ft.ni),l.vectorToWorldFrame(rt,ft.ri,ft.ri),this.result.push(ft),this.createFrictionEquationsFromContact(ft,this.frictionResult)}}}for(var ne=_,Dt=L,Pt=g,ae=H,bt=0,Tt=Y.length;bt!==Tt;bt++){F.getTriangleVertices(Y[bt],ne,Dt,Pt),F.getNormal(Y[bt],ae),tt.vsub(ne,Z);var Ut=Z.dot(ae);if(ae.scale(Ut,Z),tt.vsub(Z,Z),Ut=Z.distanceTo(tt),n.pointInTriangle(Z,ne,Dt,Pt)&&Ut<V.radius){var ft=this.createContactEquation(j,it,V,F);Z.vsub(tt,ft.ni),ft.ni.normalize(),ft.ni.scale(V.radius,ft.ri),l.pointToWorldFrame(U,rt,Z,Z),Z.vsub(it.position,ft.rj),l.vectorToWorldFrame(rt,ft.ni,ft.ni),l.vectorToWorldFrame(rt,ft.ri,ft.ri),this.result.push(ft),this.createFrictionEquationsFromContact(ft,this.frictionResult)}}Y.length=0};var m=new r,y=new r;a.prototype[e.types.SPHERE|e.types.PLANE]=a.prototype.spherePlane=function(V,F,G,U,yt,rt,j,it){var S=this.createContactEquation(j,it,V,F);if(S.ni.set(0,0,1),rt.vmult(S.ni,S.ni),S.ni.negate(S.ni),S.ni.normalize(),S.ni.mult(V.radius,S.ri),G.vsub(U,m),S.ni.mult(S.ni.dot(m),y),m.vsub(y,S.rj),-m.dot(S.ni)<=V.radius){var J=S.ri,ot=S.rj;J.vadd(G,J),J.vsub(j.position,J),ot.vadd(U,ot),ot.vsub(it.position,ot),this.result.push(S),this.createFrictionEquationsFromContact(S,this.frictionResult)}};var A=new r,O=new r,N=new r;function C(V,F,G){for(var U=null,yt=V.length,rt=0;rt!==yt;rt++){var j=V[rt],it=A;V[(rt+1)%yt].vsub(j,it);var S=O;it.cross(F,S);var J=N;G.vsub(j,J);var ot=S.dot(J);if(U===null||ot>0&&U===!0||ot<=0&&U===!1){U===null&&(U=ot>0);continue}else return!1}return!0}var W=new r,X=new r,ct=new r,st=new r,nt=[new r,new r,new r,new r,new r,new r],q=new r,Q=new r,Ct=new r,dt=new r;a.prototype[e.types.SPHERE|e.types.BOX]=a.prototype.sphereBox=function(V,F,G,U,yt,rt,j,it){var S=this.v3pool,J=nt;G.vsub(U,W),F.getSideNormals(J,rt);for(var ot=V.radius,lt=!1,tt=Q,Z=Ct,et=dt,pt=null,wt=0,Y=0,xt=0,Bt=null,It=0,bt=J.length;It!==bt&&lt===!1;It++){var Rt=X;Rt.copy(J[It]);var ft=Rt.norm();Rt.normalize();var Zt=W.dot(Rt);if(Zt<ft+ot&&Zt>0){var Kt=ct,Ut=st;Kt.copy(J[(It+1)%3]),Ut.copy(J[(It+2)%3]);var ne=Kt.norm(),Dt=Ut.norm();Kt.normalize(),Ut.normalize();var Pt=W.dot(Kt),ae=W.dot(Ut);if(Pt<ne&&Pt>-ne&&ae<Dt&&ae>-Dt){var Lt=Math.abs(Zt-ft-ot);(Bt===null||Lt<Bt)&&(Bt=Lt,Y=Pt,xt=ae,pt=ft,tt.copy(Rt),Z.copy(Kt),et.copy(Ut),wt++)}}}if(wt){lt=!0;var mt=this.createContactEquation(j,it,V,F);tt.mult(-ot,mt.ri),mt.ni.copy(tt),mt.ni.negate(mt.ni),tt.mult(pt,tt),Z.mult(Y,Z),tt.vadd(Z,tt),et.mult(xt,et),tt.vadd(et,mt.rj),mt.ri.vadd(G,mt.ri),mt.ri.vsub(j.position,mt.ri),mt.rj.vadd(U,mt.rj),mt.rj.vsub(it.position,mt.rj),this.result.push(mt),this.createFrictionEquationsFromContact(mt,this.frictionResult)}for(var Tt=S.get(),se=q,Xt=0;Xt!==2&&!lt;Xt++)for(var Ht=0;Ht!==2&&!lt;Ht++)for(var Ot=0;Ot!==2&&!lt;Ot++)if(Tt.set(0,0,0),Xt?Tt.vadd(J[0],Tt):Tt.vsub(J[0],Tt),Ht?Tt.vadd(J[1],Tt):Tt.vsub(J[1],Tt),Ot?Tt.vadd(J[2],Tt):Tt.vsub(J[2],Tt),U.vadd(Tt,se),se.vsub(G,se),se.norm2()<ot*ot){lt=!0;var mt=this.createContactEquation(j,it,V,F);mt.ri.copy(se),mt.ri.normalize(),mt.ni.copy(mt.ri),mt.ri.mult(ot,mt.ri),mt.rj.copy(Tt),mt.ri.vadd(G,mt.ri),mt.ri.vsub(j.position,mt.ri),mt.rj.vadd(U,mt.rj),mt.rj.vsub(it.position,mt.rj),this.result.push(mt),this.createFrictionEquationsFromContact(mt,this.frictionResult)}S.release(Tt),Tt=null;for(var jt=S.get(),le=S.get(),mt=S.get(),_t=S.get(),Lt=S.get(),de=J.length,Xt=0;Xt!==de&&!lt;Xt++)for(var Ht=0;Ht!==de&&!lt;Ht++)if(Xt%3!=Ht%3){J[Ht].cross(J[Xt],jt),jt.normalize(),J[Xt].vadd(J[Ht],le),mt.copy(G),mt.vsub(le,mt),mt.vsub(U,mt);var ye=mt.dot(jt);jt.mult(ye,_t);for(var Ot=0;Ot===Xt%3||Ot===Ht%3;)Ot++;Lt.copy(G),Lt.vsub(_t,Lt),Lt.vsub(le,Lt),Lt.vsub(U,Lt);var be=Math.abs(ye),Ae=Lt.norm();if(be<J[Ot].norm()&&Ae<ot){lt=!0;var Ft=this.createContactEquation(j,it,V,F);le.vadd(_t,Ft.rj),Ft.rj.copy(Ft.rj),Lt.negate(Ft.ni),Ft.ni.normalize(),Ft.ri.copy(Ft.rj),Ft.ri.vadd(U,Ft.ri),Ft.ri.vsub(G,Ft.ri),Ft.ri.normalize(),Ft.ri.mult(ot,Ft.ri),Ft.ri.vadd(G,Ft.ri),Ft.ri.vsub(j.position,Ft.ri),Ft.rj.vadd(U,Ft.rj),Ft.rj.vsub(it.position,Ft.rj),this.result.push(Ft),this.createFrictionEquationsFromContact(Ft,this.frictionResult)}}S.release(jt,le,mt,_t,Lt)};var Mt=new r,vt=new r,At=new r,gt=new r,zt=new r,Vt=new r,St=new r,Nt=new r,qt=new r,Et=new r;a.prototype[e.types.SPHERE|e.types.CONVEXPOLYHEDRON]=a.prototype.sphereConvex=function(V,F,G,U,yt,rt,j,it){var S=this.v3pool;G.vsub(U,Mt);for(var J=F.faceNormals,ot=F.faces,lt=F.vertices,tt=V.radius,Z=0;Z!==lt.length;Z++){var et=lt[Z],pt=zt;rt.vmult(et,pt),U.vadd(pt,pt);var wt=gt;if(pt.vsub(G,wt),wt.norm2()<tt*tt){xt=!0;var Y=this.createContactEquation(j,it,V,F);Y.ri.copy(wt),Y.ri.normalize(),Y.ni.copy(Y.ri),Y.ri.mult(tt,Y.ri),pt.vsub(U,Y.rj),Y.ri.vadd(G,Y.ri),Y.ri.vsub(j.position,Y.ri),Y.rj.vadd(U,Y.rj),Y.rj.vsub(it.position,Y.rj),this.result.push(Y),this.createFrictionEquationsFromContact(Y,this.frictionResult);return}}for(var xt=!1,Z=0,Bt=ot.length;Z!==Bt&&xt===!1;Z++){var It=J[Z],bt=ot[Z],Rt=Vt;rt.vmult(It,Rt);var ft=St;rt.vmult(lt[bt[0]],ft),ft.vadd(U,ft);var Zt=Nt;Rt.mult(-tt,Zt),G.vadd(Zt,Zt);var Kt=qt;Zt.vsub(ft,Kt);var Ut=Kt.dot(Rt),ne=Et;if(G.vsub(ft,ne),Ut<0&&ne.dot(Rt)>0){for(var Dt=[],Pt=0,ae=bt.length;Pt!==ae;Pt++){var Tt=S.get();rt.vmult(lt[bt[Pt]],Tt),U.vadd(Tt,Tt),Dt.push(Tt)}if(C(Dt,Rt,G)){xt=!0;var Y=this.createContactEquation(j,it,V,F);Rt.mult(-tt,Y.ri),Rt.negate(Y.ni);var se=S.get();Rt.mult(-Ut,se);var Xt=S.get();Rt.mult(-tt,Xt),G.vsub(U,Y.rj),Y.rj.vadd(Xt,Y.rj),Y.rj.vadd(se,Y.rj),Y.rj.vadd(U,Y.rj),Y.rj.vsub(it.position,Y.rj),Y.ri.vadd(G,Y.ri),Y.ri.vsub(j.position,Y.ri),S.release(se),S.release(Xt),this.result.push(Y),this.createFrictionEquationsFromContact(Y,this.frictionResult);for(var Pt=0,Ht=Dt.length;Pt!==Ht;Pt++)S.release(Dt[Pt]);return}else for(var Pt=0;Pt!==bt.length;Pt++){var Ot=S.get(),jt=S.get();rt.vmult(lt[bt[(Pt+1)%bt.length]],Ot),rt.vmult(lt[bt[(Pt+2)%bt.length]],jt),U.vadd(Ot,Ot),U.vadd(jt,jt);var le=vt;jt.vsub(Ot,le);var mt=At;le.unit(mt);var _t=S.get(),Lt=S.get();G.vsub(Ot,Lt);var de=Lt.dot(mt);mt.mult(de,_t),_t.vadd(Ot,_t);var ye=S.get();if(_t.vsub(G,ye),de>0&&de*de<le.norm2()&&ye.norm2()<tt*tt){var Y=this.createContactEquation(j,it,V,F);_t.vsub(U,Y.rj),_t.vsub(G,Y.ni),Y.ni.normalize(),Y.ni.mult(tt,Y.ri),Y.rj.vadd(U,Y.rj),Y.rj.vsub(it.position,Y.rj),Y.ri.vadd(G,Y.ri),Y.ri.vsub(j.position,Y.ri),this.result.push(Y),this.createFrictionEquationsFromContact(Y,this.frictionResult);for(var Pt=0,Ht=Dt.length;Pt!==Ht;Pt++)S.release(Dt[Pt]);S.release(Ot),S.release(jt),S.release(_t),S.release(ye),S.release(Lt);return}S.release(Ot),S.release(jt),S.release(_t),S.release(ye),S.release(Lt)}for(var Pt=0,Ht=Dt.length;Pt!==Ht;Pt++)S.release(Dt[Pt])}}},new r,new r,a.prototype[e.types.PLANE|e.types.BOX]=a.prototype.planeBox=function(V,F,G,U,yt,rt,j,it){F.convexPolyhedronRepresentation.material=F.material,F.convexPolyhedronRepresentation.collisionResponse=F.collisionResponse,this.planeConvex(V,F.convexPolyhedronRepresentation,G,U,yt,rt,j,it)};var kt=new r,oe=new r,he=new r,re=new r;a.prototype[e.types.PLANE|e.types.CONVEXPOLYHEDRON]=a.prototype.planeConvex=function(V,F,G,U,yt,rt,j,it){var S=kt,J=oe;J.set(0,0,1),yt.vmult(J,J);for(var ot=0,lt=he,tt=0;tt!==F.vertices.length;tt++){S.copy(F.vertices[tt]),rt.vmult(S,S),U.vadd(S,S),S.vsub(G,lt);var Z=J.dot(lt);if(Z<=0){var et=this.createContactEquation(j,it,V,F),pt=re;J.mult(J.dot(lt),pt),S.vsub(pt,pt),pt.vsub(G,et.ri),et.ni.copy(J),S.vsub(U,et.rj),et.ri.vadd(G,et.ri),et.ri.vsub(j.position,et.ri),et.rj.vadd(U,et.rj),et.rj.vsub(it.position,et.rj),this.result.push(et),ot++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(et,this.frictionResult)}}this.enableFrictionReduction&&ot&&this.createFrictionFromAverage(ot)};var te=new r,Qt=new r;a.prototype[e.types.CONVEXPOLYHEDRON]=a.prototype.convexConvex=function(V,F,G,U,yt,rt,j,it,S,J,ot,lt){var tt=te;if(!(G.distanceTo(U)>V.boundingSphereRadius+F.boundingSphereRadius)&&V.findSeparatingAxis(F,G,yt,U,rt,tt,ot,lt)){var Z=[],et=Qt;V.clipAgainstHull(G,yt,F,U,rt,tt,-100,100,Z);for(var pt=0,wt=0;wt!==Z.length;wt++){var Y=this.createContactEquation(j,it,V,F,S,J),xt=Y.ri,Bt=Y.rj;tt.negate(Y.ni),Z[wt].normal.negate(et),et.mult(Z[wt].depth,et),Z[wt].point.vadd(et,xt),Bt.copy(Z[wt].point),xt.vsub(G,xt),Bt.vsub(U,Bt),xt.vadd(G,xt),xt.vsub(j.position,xt),Bt.vadd(U,Bt),Bt.vsub(it.position,Bt),this.result.push(Y),pt++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(Y,this.frictionResult)}this.enableFrictionReduction&&pt&&this.createFrictionFromAverage(pt)}};var ue=new r,ce=new r,ee=new r;a.prototype[e.types.PLANE|e.types.PARTICLE]=a.prototype.planeParticle=function(V,F,G,U,yt,rt,j,it){var S=ue;S.set(0,0,1),j.quaternion.vmult(S,S);var J=ce;U.vsub(j.position,J);var ot=S.dot(J);if(ot<=0){var lt=this.createContactEquation(it,j,F,V);lt.ni.copy(S),lt.ni.negate(lt.ni),lt.ri.set(0,0,0);var tt=ee;S.mult(S.dot(U),tt),U.vsub(tt,tt),lt.rj.copy(tt),this.result.push(lt),this.createFrictionEquationsFromContact(lt,this.frictionResult)}};var Jt=new r;a.prototype[e.types.PARTICLE|e.types.SPHERE]=a.prototype.sphereParticle=function(V,F,G,U,yt,rt,j,it){var S=Jt;S.set(0,0,1),U.vsub(G,S);var J=S.norm2();if(J<=V.radius*V.radius){var ot=this.createContactEquation(it,j,F,V);S.normalize(),ot.rj.copy(S),ot.rj.mult(V.radius,ot.rj),ot.ni.copy(S),ot.ni.negate(ot.ni),ot.ri.set(0,0,0),this.result.push(ot),this.createFrictionEquationsFromContact(ot,this.frictionResult)}};var Yt=new o,ie=new r;new r;var $t=new r,Gt=new r,pe=new r;a.prototype[e.types.PARTICLE|e.types.CONVEXPOLYHEDRON]=a.prototype.convexParticle=function(V,F,G,U,yt,rt,j,it){var S=-1,J=$t,ot=pe,lt=null,tt=ie;if(tt.copy(U),tt.vsub(G,tt),yt.conjugate(Yt),Yt.vmult(tt,tt),V.pointIsInside(tt)){V.worldVerticesNeedsUpdate&&V.computeWorldVertices(G,yt),V.worldFaceNormalsNeedsUpdate&&V.computeWorldFaceNormals(yt);for(var Z=0,et=V.faces.length;Z!==et;Z++){var pt=[V.worldVertices[V.faces[Z][0]]],wt=V.worldFaceNormals[Z];U.vsub(pt[0],Gt);var Y=-wt.dot(Gt);(lt===null||Math.abs(Y)<Math.abs(lt))&&(lt=Y,S=Z,J.copy(wt))}if(S!==-1){var xt=this.createContactEquation(it,j,F,V);J.mult(lt,ot),ot.vadd(U,ot),ot.vsub(G,ot),xt.rj.copy(ot),J.negate(xt.ni),xt.ri.set(0,0,0);var Bt=xt.ri,It=xt.rj;Bt.vadd(U,Bt),Bt.vsub(it.position,Bt),It.vadd(G,It),It.vsub(j.position,It),this.result.push(xt),this.createFrictionEquationsFromContact(xt,this.frictionResult)}else console.warn("Point found inside convex, but did not find penetrating face!")}},a.prototype[e.types.BOX|e.types.HEIGHTFIELD]=a.prototype.boxHeightfield=function(V,F,G,U,yt,rt,j,it){V.convexPolyhedronRepresentation.material=V.material,V.convexPolyhedronRepresentation.collisionResponse=V.collisionResponse,this.convexHeightfield(V.convexPolyhedronRepresentation,F,G,U,yt,rt,j,it)};var ve=new r,fe=new r,me=[0];a.prototype[e.types.CONVEXPOLYHEDRON|e.types.HEIGHTFIELD]=a.prototype.convexHeightfield=function(V,F,G,U,yt,rt,j,it){var S=F.data,J=F.elementSize,ot=V.boundingSphereRadius,lt=fe,tt=me,Z=ve;l.pointToLocalFrame(U,rt,G,Z);var et=Math.floor((Z.x-ot)/J)-1,pt=Math.ceil((Z.x+ot)/J)+1,wt=Math.floor((Z.y-ot)/J)-1,Y=Math.ceil((Z.y+ot)/J)+1;if(!(pt<0||Y<0||et>S.length||wt>S[0].length)){et<0&&(et=0),pt<0&&(pt=0),wt<0&&(wt=0),Y<0&&(Y=0),et>=S.length&&(et=S.length-1),pt>=S.length&&(pt=S.length-1),Y>=S[0].length&&(Y=S[0].length-1),wt>=S[0].length&&(wt=S[0].length-1);var xt=[];F.getRectMinMax(et,wt,pt,Y,xt);var Bt=xt[0],It=xt[1];if(!(Z.z-ot>It||Z.z+ot<Bt))for(var bt=et;bt<pt;bt++)for(var Rt=wt;Rt<Y;Rt++)F.getConvexTrianglePillar(bt,Rt,!1),l.pointToWorldFrame(U,rt,F.pillarOffset,lt),G.distanceTo(lt)<F.pillarConvex.boundingSphereRadius+V.boundingSphereRadius&&this.convexConvex(V,F.pillarConvex,G,lt,yt,rt,j,it,null,null,tt,null),F.getConvexTrianglePillar(bt,Rt,!0),l.pointToWorldFrame(U,rt,F.pillarOffset,lt),G.distanceTo(lt)<F.pillarConvex.boundingSphereRadius+V.boundingSphereRadius&&this.convexConvex(V,F.pillarConvex,G,lt,yt,rt,j,it,null,null,tt,null)}};var we=new r,Wt=new r;a.prototype[e.types.SPHERE|e.types.HEIGHTFIELD]=a.prototype.sphereHeightfield=function(V,F,G,U,yt,rt,j,it){var S=F.data,J=V.radius,ot=F.elementSize,lt=Wt,tt=we;l.pointToLocalFrame(U,rt,G,tt);var Z=Math.floor((tt.x-J)/ot)-1,et=Math.ceil((tt.x+J)/ot)+1,pt=Math.floor((tt.y-J)/ot)-1,wt=Math.ceil((tt.y+J)/ot)+1;if(!(et<0||wt<0||Z>S.length||wt>S[0].length)){Z<0&&(Z=0),et<0&&(et=0),pt<0&&(pt=0),wt<0&&(wt=0),Z>=S.length&&(Z=S.length-1),et>=S.length&&(et=S.length-1),wt>=S[0].length&&(wt=S[0].length-1),pt>=S[0].length&&(pt=S[0].length-1);var Y=[];F.getRectMinMax(Z,pt,et,wt,Y);var xt=Y[0],Bt=Y[1];if(!(tt.z-J>Bt||tt.z+J<xt))for(var It=this.result,bt=Z;bt<et;bt++)for(var Rt=pt;Rt<wt;Rt++){var ft=It.length;F.getConvexTrianglePillar(bt,Rt,!1),l.pointToWorldFrame(U,rt,F.pillarOffset,lt),G.distanceTo(lt)<F.pillarConvex.boundingSphereRadius+V.boundingSphereRadius&&this.sphereConvex(V,F.pillarConvex,G,lt,yt,rt,j,it),F.getConvexTrianglePillar(bt,Rt,!0),l.pointToWorldFrame(U,rt,F.pillarOffset,lt),G.distanceTo(lt)<F.pillarConvex.boundingSphereRadius+V.boundingSphereRadius&&this.sphereConvex(V,F.pillarConvex,G,lt,yt,rt,j,it);var Zt=It.length-ft;if(Zt>2)return}}}},{"../collision/AABB":3,"../collision/Ray":9,"../equations/ContactEquation":19,"../equations/FrictionEquation":21,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../shapes/ConvexPolyhedron":38,"../shapes/Shape":43,"../solver/Solver":47,"../utils/Vec3Pool":54}],56:[function(v,I,ht){I.exports=d;var p=v("../shapes/Shape"),e=v("../math/Vec3"),n=v("../math/Quaternion"),r=v("../solver/GSSolver");v("../utils/Vec3Pool"),v("../equations/ContactEquation"),v("../equations/FrictionEquation");var l=v("./Narrowphase"),o=v("../utils/EventTarget"),t=v("../collision/ArrayCollisionMatrix"),i=v("../material/Material"),s=v("../material/ContactMaterial"),a=v("../objects/Body"),c=v("../utils/TupleDictionary"),h=v("../collision/RaycastResult"),u=v("../collision/AABB"),f=v("../collision/Ray"),w=v("../collision/NaiveBroadphase");function d(){o.apply(this),this.dt=-1,this.allowSleep=!1,this.contacts=[],this.frictionEquations=[],this.quatNormalizeSkip=0,this.quatNormalizeFast=!1,this.time=0,this.stepnumber=0,this.default_dt=1/60,this.nextId=0,this.gravity=new e,this.broadphase=new w,this.bodies=[],this.solver=new r,this.constraints=[],this.narrowphase=new l(this),this.collisionMatrix=new t,this.collisionMatrixPrevious=new t,this.materials=[],this.contactmaterials=[],this.contactMaterialTable=new c,this.defaultMaterial=new i("default"),this.defaultContactMaterial=new s(this.defaultMaterial,this.defaultMaterial,{friction:.3,restitution:0}),this.doProfiling=!1,this.profile={solve:0,makeContactConstraints:0,broadphase:0,integrate:0,narrowphase:0},this.subsystems=[],this.addBodyEvent={type:"addBody",body:null},this.removeBodyEvent={type:"removeBody",body:null}}d.prototype=new o,new u;var b=new f;if(d.prototype.getContactMaterial=function(E,_){return this.contactMaterialTable.get(E.id,_.id)},d.prototype.numObjects=function(){return this.bodies.length},d.prototype.collisionMatrixTick=function(){var E=this.collisionMatrixPrevious;this.collisionMatrixPrevious=this.collisionMatrix,this.collisionMatrix=E,this.collisionMatrix.reset()},d.prototype.add=d.prototype.addBody=function(E){this.bodies.indexOf(E)===-1&&(E.index=this.bodies.length,this.bodies.push(E),E.world=this,E.initPosition.copy(E.position),E.initVelocity.copy(E.velocity),E.timeLastSleepy=this.time,E instanceof a&&(E.initAngularVelocity.copy(E.angularVelocity),E.initQuaternion.copy(E.quaternion)),this.collisionMatrix.setNumObjects(this.bodies.length),this.addBodyEvent.body=E,this.dispatchEvent(this.addBodyEvent))},d.prototype.addConstraint=function(E){this.constraints.push(E)},d.prototype.removeConstraint=function(E){var _=this.constraints.indexOf(E);_!==-1&&this.constraints.splice(_,1)},d.prototype.rayTest=function(E,_,L){L instanceof h?this.raycastClosest(E,_,{skipBackfaces:!0},L):this.raycastAll(E,_,{skipBackfaces:!0},L)},d.prototype.raycastAll=function(E,_,L,g){return L.mode=f.ALL,L.from=E,L.to=_,L.callback=g,b.intersectWorld(this,L)},d.prototype.raycastAny=function(E,_,L,g){return L.mode=f.ANY,L.from=E,L.to=_,L.result=g,b.intersectWorld(this,L)},d.prototype.raycastClosest=function(E,_,L,g){return L.mode=f.CLOSEST,L.from=E,L.to=_,L.result=g,b.intersectWorld(this,L)},d.prototype.remove=function(E){E.world=null;var _=this.bodies.length-1,L=this.bodies,g=L.indexOf(E);if(g!==-1){L.splice(g,1);for(var P=0;P!==L.length;P++)L[P].index=P;this.collisionMatrix.setNumObjects(_),this.removeBodyEvent.body=E,this.dispatchEvent(this.removeBodyEvent)}},d.prototype.removeBody=d.prototype.remove,d.prototype.addMaterial=function(E){this.materials.push(E)},d.prototype.addContactMaterial=function(E){this.contactmaterials.push(E),this.contactMaterialTable.set(E.materials[0].id,E.materials[1].id,E)},typeof performance=="undefined"&&(performance={}),!performance.now){var k=Date.now();performance.timing&&performance.timing.navigationStart&&(k=performance.timing.navigationStart),performance.now=function(){return Date.now()-k}}var at=new e;d.prototype.step=function(E,_,L){if(L=L||10,_=_||0,_===0)this.internalStep(E),this.time+=E;else{var g=Math.floor((this.time+_)/E)-Math.floor(this.time/E);g=Math.min(g,L);for(var P=performance.now(),x=0;x!==g&&(this.internalStep(E),!(performance.now()-P>E*1e3));x++);this.time+=_;for(var m=this.time%E,y=m/E,A=at,O=this.bodies,N=0;N!==O.length;N++){var C=O[N];C.type!==a.STATIC&&C.sleepState!==a.SLEEPING?(C.position.vsub(C.previousPosition,A),A.scale(y,A),C.position.vadd(A,C.interpolatedPosition)):(C.interpolatedPosition.copy(C.position),C.interpolatedQuaternion.copy(C.quaternion))}}};var T={type:"postStep"},H={type:"preStep"},z={type:"collide",body:null,contact:null},B=[],R=[],D=[],$=[];new e,new e,new e,new e,new e,new e,new e,new e,new e,new n;var K=new n,ut=new n,M=new e;d.prototype.internalStep=function(E){this.dt=E;var _=this.contacts,L=D,g=$,P=this.numObjects(),x=this.bodies,m=this.solver,y=this.gravity,A=this.doProfiling,O=this.profile,N=a.DYNAMIC,C,W=this.constraints,X=R;y.norm();var ct=y.x,st=y.y,nt=y.z,q=0;for(A&&(C=performance.now()),q=0;q!==P;q++){var Q=x[q];if(Q.type&N){var Ct=Q.force,dt=Q.mass;Ct.x+=dt*ct,Ct.y+=dt*st,Ct.z+=dt*nt}}for(var q=0,Mt=this.subsystems.length;q!==Mt;q++)this.subsystems[q].update();A&&(C=performance.now()),L.length=0,g.length=0,this.broadphase.collisionPairs(this,L,g),A&&(O.broadphase=performance.now()-C);var vt=W.length;for(q=0;q!==vt;q++){var At=W[q];if(!At.collideConnected)for(var gt=L.length-1;gt>=0;gt-=1)(At.bodyA===L[gt]&&At.bodyB===g[gt]||At.bodyB===L[gt]&&At.bodyA===g[gt])&&(L.splice(gt,1),g.splice(gt,1))}this.collisionMatrixTick(),A&&(C=performance.now());var zt=B,Vt=_.length;for(q=0;q!==Vt;q++)zt.push(_[q]);_.length=0;var St=this.frictionEquations.length;for(q=0;q!==St;q++)X.push(this.frictionEquations[q]);this.frictionEquations.length=0,this.narrowphase.getContacts(L,g,this,_,zt,this.frictionEquations,X),A&&(O.narrowphase=performance.now()-C),A&&(C=performance.now());for(var q=0;q<this.frictionEquations.length;q++)m.addEquation(this.frictionEquations[q]);for(var Nt=_.length,qt=0;qt!==Nt;qt++){var At=_[qt],Q=At.bi,Et=At.bj;At.si,At.sj;var kt;if(Q.material&&Et.material?kt=this.getContactMaterial(Q.material,Et.material)||this.defaultContactMaterial:kt=this.defaultContactMaterial,kt.friction,Q.material&&Et.material&&(Q.material.friction>=0&&Et.material.friction>=0&&Q.material.friction*Et.material.friction,Q.material.restitution>=0&&Et.material.restitution>=0&&(At.restitution=Q.material.restitution*Et.material.restitution)),m.addEquation(At),Q.allowSleep&&Q.type===a.DYNAMIC&&Q.sleepState===a.SLEEPING&&Et.sleepState===a.AWAKE&&Et.type!==a.STATIC){var oe=Et.velocity.norm2()+Et.angularVelocity.norm2(),he=Math.pow(Et.sleepSpeedLimit,2);oe>=he*2&&(Q._wakeUpAfterNarrowphase=!0)}if(Et.allowSleep&&Et.type===a.DYNAMIC&&Et.sleepState===a.SLEEPING&&Q.sleepState===a.AWAKE&&Q.type!==a.STATIC){var re=Q.velocity.norm2()+Q.angularVelocity.norm2(),te=Math.pow(Q.sleepSpeedLimit,2);re>=te*2&&(Et._wakeUpAfterNarrowphase=!0)}this.collisionMatrix.set(Q,Et,!0),this.collisionMatrixPrevious.get(Q,Et)||(z.body=Et,z.contact=At,Q.dispatchEvent(z),z.body=Q,Et.dispatchEvent(z))}for(A&&(O.makeContactConstraints=performance.now()-C,C=performance.now()),q=0;q!==P;q++){var Q=x[q];Q._wakeUpAfterNarrowphase&&(Q.wakeUp(),Q._wakeUpAfterNarrowphase=!1)}var vt=W.length;for(q=0;q!==vt;q++){var At=W[q];At.update();for(var gt=0,Qt=At.equations.length;gt!==Qt;gt++){var ue=At.equations[gt];m.addEquation(ue)}}m.solve(E,this),A&&(O.solve=performance.now()-C),m.removeAllEquations();var ce=Math.pow;for(q=0;q!==P;q++){var Q=x[q];if(Q.type&N){var ee=ce(1-Q.linearDamping,E),Jt=Q.velocity;Jt.mult(ee,Jt);var Yt=Q.angularVelocity;if(Yt){var ie=ce(1-Q.angularDamping,E);Yt.mult(ie,Yt)}}}for(this.dispatchEvent(H),q=0;q!==P;q++){var Q=x[q];Q.preStep&&Q.preStep.call(Q)}A&&(C=performance.now());var $t=K,Gt=ut,pe=this.stepnumber,ve=a.DYNAMIC|a.KINEMATIC,fe=pe%(this.quatNormalizeSkip+1)==0,me=this.quatNormalizeFast,we=E*.5;for(p.types.PLANE,p.types.CONVEXPOLYHEDRON,q=0;q!==P;q++){var Wt=x[q],V=Wt.force,F=Wt.torque;if(Wt.type&ve&&Wt.sleepState!==a.SLEEPING){var G=Wt.velocity,U=Wt.angularVelocity,yt=Wt.position,rt=Wt.quaternion,j=Wt.invMass,it=Wt.invInertiaWorld;G.x+=V.x*j*E,G.y+=V.y*j*E,G.z+=V.z*j*E,Wt.angularVelocity&&(it.vmult(F,M),M.mult(E,M),M.vadd(U,U)),yt.x+=G.x*E,yt.y+=G.y*E,yt.z+=G.z*E,Wt.angularVelocity&&($t.set(U.x,U.y,U.z,0),$t.mult(rt,Gt),rt.x+=we*Gt.x,rt.y+=we*Gt.y,rt.z+=we*Gt.z,rt.w+=we*Gt.w,fe&&(me?rt.normalizeFast():rt.normalize())),Wt.aabb&&(Wt.aabbNeedsUpdate=!0),Wt.updateInertiaWorld&&Wt.updateInertiaWorld()}}for(this.clearForces(),this.broadphase.dirty=!0,A&&(O.integrate=performance.now()-C),this.time+=E,this.stepnumber+=1,this.dispatchEvent(T),q=0;q!==P;q++){var Q=x[q],S=Q.postStep;S&&S.call(Q)}if(this.allowSleep)for(q=0;q!==P;q++)x[q].sleepTick(this.time)},d.prototype.clearForces=function(){for(var E=this.bodies,_=E.length,L=0;L!==_;L++){var g=E[L];g.force,g.torque,g.force.set(0,0,0),g.torque.set(0,0,0)}}},{"../collision/AABB":3,"../collision/ArrayCollisionMatrix":4,"../collision/NaiveBroadphase":7,"../collision/Ray":9,"../collision/RaycastResult":10,"../equations/ContactEquation":19,"../equations/FrictionEquation":21,"../material/ContactMaterial":24,"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Shape":43,"../solver/GSSolver":46,"../utils/EventTarget":49,"../utils/TupleDictionary":52,"../utils/Vec3Pool":54,"./Narrowphase":55}]},{},[2])(2)})})(Be);var Ce=Be.exports;export{Ce as C,Be as c};
